import axios from 'axios';

// ä»ç¯å¢ƒå˜é‡è·å–APIé…ç½®
const API_URL = import.meta.env.VITE_API_URL || 'https://dashscope.aliyuncs.com/compatible-mode/v1';
const API_KEY = import.meta.env.VITE_API_KEY || '';
const API_MODEL = import.meta.env.VITE_API_MODEL || 'qwen-max';

// æ˜Ÿåº§åç§°æ˜ å°„ï¼ˆè‹±æ–‡åˆ°ä¸­æ–‡ï¼‰
const zodiacMap = {
  'aries': 'ç™½ç¾Šåº§',
  'taurus': 'é‡‘ç‰›åº§',
  'gemini': 'åŒå­åº§',
  'cancer': 'å·¨èŸ¹åº§',
  'leo': 'ç‹®å­åº§',
  'virgo': 'å¤„å¥³åº§',
  'libra': 'å¤©ç§¤åº§',
  'scorpio': 'å¤©èåº§',
  'sagittarius': 'å°„æ‰‹åº§',
  'capricorn': 'æ‘©ç¾¯åº§',
  'aquarius': 'æ°´ç“¶åº§',
  'pisces': 'åŒé±¼åº§'
};

// æ¨¡å‹å“åº”æ—¶é—´è®°å½•
const modelResponseTimes = {
  'qwen-max': 2000,  // é¢„ä¼°å€¼ï¼Œå•ä½ms
  'qwen-plus': 1500,
  'qwen-turbo': 1000,
  'deepseek-r1': 20000,
  'default': 3000
};

// å“åº”æ—¶é—´å†å²è®°å½•ï¼Œç”¨äºåŠ¨æ€è°ƒæ•´
const responseTimeHistory = {};

/**
 * è·å–æ¨¡å‹çš„é¢„ä¼°å“åº”æ—¶é—´
 * @param {string} model æ¨¡å‹åç§°
 * @returns {number} é¢„ä¼°å“åº”æ—¶é—´(ms)
 */
export function getEstimatedResponseTime(model) {
  // å¦‚æœæœ‰å†å²è®°å½•ï¼Œè¿”å›å†å²å¹³å‡å€¼
  if (responseTimeHistory[model] && responseTimeHistory[model].length > 0) {
    const sum = responseTimeHistory[model].reduce((a, b) => a + b, 0);
    return Math.floor(sum / responseTimeHistory[model].length);
  }
  
  // å¦åˆ™è¿”å›é¢„è®¾å€¼
  return modelResponseTimes[model] || modelResponseTimes['default'];
}

/**
 * è®°å½•æ¨¡å‹å“åº”æ—¶é—´
 * @param {string} model æ¨¡å‹åç§°
 * @param {number} time å“åº”æ—¶é—´(ms)
 */
function recordResponseTime(model, time) {
  if (!responseTimeHistory[model]) {
    responseTimeHistory[model] = [];
  }
  
  // ä¿æŒæœ€å¤š10æ¡å†å²è®°å½•
  if (responseTimeHistory[model].length >= 10) {
    responseTimeHistory[model].shift();
  }
  
  responseTimeHistory[model].push(time);
}

/**
 * è·å–æ˜Ÿåº§ç‰¹è´¨æè¿°
 * @param {string} zodiac æ˜Ÿåº§åç§°
 * @returns {string} æ˜Ÿåº§ç‰¹è´¨æè¿°
 */
function getZodiacTraits(zodiac) {
  const traits = {
    'aries': 'çƒ­æƒ…ã€ç§¯æã€ç›´æ¥ï¼Œæ¸´æœ›æ–°æŒ‘æˆ˜ï¼Œæœ‰æ—¶ç¼ºä¹è€å¿ƒï¼Œåšäº‹æœæ–­',
    'taurus': 'è¸å®ã€å¯é ã€é‡è§†ç¨³å®šï¼Œè¿½æ±‚ç¾å¥½ç”Ÿæ´»ï¼Œæœ‰æ—¶å›ºæ‰§ï¼Œéœ€è¦æ—¶é—´æ¥å—å˜åŒ–',
    'gemini': 'å¥½å¥‡ã€çµæ´»ã€å–„äºäº¤æµï¼Œå–œæ¬¢å¤šæ ·æ€§ï¼Œå¯èƒ½æ³¨æ„åŠ›åˆ†æ•£ï¼Œæ€ç»´è·³è·ƒ',
    'cancer': 'æ•æ„Ÿã€å¯ŒåŒæƒ…å¿ƒã€é‡è§†å®¶åº­ï¼Œæƒ…æ„Ÿä¸°å¯Œï¼Œæœ‰æ—¶æƒ…ç»ªæ³¢åŠ¨ï¼Œéœ€è¦å®‰å…¨æ„Ÿ',
    'leo': 'è‡ªä¿¡ã€æ…·æ…¨ã€æœ‰åˆ›é€ åŠ›ï¼Œå¯»æ±‚è®¤å¯ï¼Œæœ‰æ—¶è‡ªæˆ‘ä¸­å¿ƒï¼Œæ¸´æœ›è¢«èµèµ',
    'virgo': 'ç»†è‡´ã€å®é™…ã€åˆ†æèƒ½åŠ›å¼ºï¼Œè¿½æ±‚å®Œç¾ï¼Œæœ‰æ—¶è¿‡åº¦æ‰¹åˆ¤ï¼Œå–„äºè§£å†³é—®é¢˜',
    'libra': 'å’Œå¹³ã€å…¬æ­£ã€è¿½æ±‚å’Œè°ï¼Œé‡è§†å…³ç³»ï¼Œæœ‰æ—¶ä¼˜æŸ”å¯¡æ–­ï¼Œå–„äºçœ‹åˆ°å¤šæ–¹é¢',
    'scorpio': 'çƒ­æƒ…ã€åšå®šã€æ´å¯ŸåŠ›å¼ºï¼Œæƒ…æ„Ÿæ·±æ²‰ï¼Œæœ‰æ—¶å¤šç–‘ï¼Œå¯¹ä¿¡ä»»è¦æ±‚é«˜',
    'sagittarius': 'ä¹è§‚ã€è¯šå®ã€è¿½æ±‚è‡ªç”±ï¼Œçƒ­çˆ±å†’é™©ï¼Œæœ‰æ—¶ç¼ºä¹è€å¿ƒï¼Œç›´è¨€ä¸è®³',
    'capricorn': 'åŠ¡å®ã€æœ‰è§„åˆ’ã€è‡ªå¾‹ï¼Œç›®æ ‡æ˜ç¡®ï¼Œæœ‰æ—¶è¿‡äºä¸¥è‚ƒï¼Œè´£ä»»æ„Ÿå¼º',
    'aquarius': 'ç‹¬ç«‹ã€åˆ›æ–°ã€äººé“ä¸»ä¹‰ï¼Œæ€æƒ³å¼€æ”¾ï¼Œæœ‰æ—¶æ˜¾å¾—ç–è¿œï¼Œæ³¨é‡ä¸ªæ€§',
    'pisces': 'å¯Œæœ‰åŒæƒ…å¿ƒã€ç›´è§‰æ•é”ã€å¯Œæƒ³è±¡åŠ›ï¼Œæƒ…æ„Ÿä¸°å¯Œï¼Œæœ‰æ—¶é€ƒé¿ç°å®ï¼Œå–„è§£äººæ„'
  };
  
  return traits[zodiac] || 'ç‹¬ç‰¹çš„æ€§æ ¼ç‰¹ç‚¹';
}

/**
 * è·å–æ˜Ÿåº§è¿åŠ¿ä¿¡æ¯
 * @param {string} zodiac æ˜Ÿåº§ç´¢å¼•(0-11)æˆ–è‹±æ–‡åç§°
 * @param {string} aspect è¿åŠ¿æ–¹é¢(overall|love|career|wealth)
 * @returns {Promise<Object>} æ˜Ÿåº§è¿åŠ¿ä¿¡æ¯
 */
async function getZodiacFortune(zodiacParam, aspect = 'overall') {
  try {
    // å¦‚æœä¼ å…¥çš„æ˜¯æ˜Ÿåº§è‹±æ–‡åç§°ï¼Œéœ€è¦è½¬æ¢ä¸ºç´¢å¼•
    let zodiacIndex = zodiacParam;
    if (typeof zodiacParam === 'string' && isNaN(zodiacParam)) {
      const zodiacNames = Object.keys(zodiacMap);
      zodiacIndex = zodiacNames.indexOf(zodiacParam.toLowerCase());
      if (zodiacIndex === -1) zodiacIndex = 0; // é»˜è®¤ä¸ºç™½ç¾Šåº§
    }
    
    // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…(0-11)
    zodiacIndex = Math.max(0, Math.min(11, parseInt(zodiacIndex)));
    
    // è°ƒç”¨API
    const response = await axios.get(`http://127.0.0.1:5000/api/astro/${zodiacIndex}?convert=true`);
    
    if (response.data) {
      // è§£æè¿”å›çš„è¿åŠ¿æ•°æ®
      const items = response.data.items || [];
      const fortuneData = {
        title: response.data.title || `ä»Šæ—¥${zodiacMap[Object.keys(zodiacMap)[zodiacIndex]]}è¿åŠ¿`,
        overall: { rating: '', content: '' },
        love: { rating: '', content: '' },
        career: { rating: '', content: '' },
        wealth: { rating: '', content: '' }
      };
      
      // è§£æè¿åŠ¿è¯„åˆ†å’Œå†…å®¹
      for (let i = 0; i < items.length; i += 2) {
        if (items[i].includes('æ•´é«”') || items[i].includes('æ•´ä½“')) {
          fortuneData.overall.rating = items[i].replace(/.*æ•´[é«”ä½“]é‹å‹¢/, '').trim();
          fortuneData.overall.content = items[i + 1] || '';
        } else if (items[i].includes('æ„›æƒ…') || items[i].includes('çˆ±æƒ…')) {
          fortuneData.love.rating = items[i].replace(/.*æ„›?æƒ…é‹å‹¢/, '').trim();
          fortuneData.love.content = items[i + 1] || '';
        } else if (items[i].includes('äº‹æ¥­') || items[i].includes('äº‹ä¸š')) {
          fortuneData.career.rating = items[i].replace(/.*äº‹[æ¥­ä¸š]é‹å‹¢/, '').trim();
          fortuneData.career.content = items[i + 1] || '';
        } else if (items[i].includes('è²¡é‹') || items[i].includes('è´¢è¿')) {
          fortuneData.wealth.rating = items[i].replace(/.*è²¡?é‹é‹å‹¢/, '').trim();
          fortuneData.wealth.content = items[i + 1] || '';
        }
      }
      
      // è¿”å›æŒ‡å®šæ–¹é¢çš„è¿åŠ¿æˆ–æ•´ä½“è¿åŠ¿
      return {
        all: fortuneData,
        selected: aspect === 'overall' ? fortuneData.overall : 
                  aspect === 'love' ? fortuneData.love :
                  aspect === 'career' ? fortuneData.career : 
                  aspect === 'wealth' ? fortuneData.wealth : fortuneData.overall
      };
    }
    
    throw new Error('è¿åŠ¿æ•°æ®è§£æå¤±è´¥');
  } catch (error) {
    console.error('è·å–æ˜Ÿåº§è¿åŠ¿å¤±è´¥:', error);
    // è¿”å›é»˜è®¤è¿åŠ¿ï¼Œé¿å…æ•´ä¸ªæµç¨‹ä¸­æ–­
    return {
      all: {
        title: `ä»Šæ—¥${zodiacMap[Object.keys(zodiacMap)[typeof zodiacParam === 'string' ? 0 : zodiacParam]]}è¿åŠ¿`,
        overall: { rating: 'â˜…â˜…â˜…â˜†â˜†', content: 'ä»Šæ—¥è¿åŠ¿ä¸€èˆ¬ï¼Œä¿æŒå¹³å¸¸å¿ƒã€‚' },
        love: { rating: 'â˜…â˜…â˜…â˜†â˜†', content: 'æ„Ÿæƒ…ä¸Šéœ€è¦å¤šä¸€äº›ç†è§£å’ŒåŒ…å®¹ã€‚' },
        career: { rating: 'â˜…â˜…â˜…â˜†â˜†', content: 'å·¥ä½œä¸­å¯èƒ½ä¼šé‡åˆ°ä¸€äº›æŒ‘æˆ˜ï¼Œä½†æ€»ä½“å¹³ç¨³ã€‚' },
        wealth: { rating: 'â˜…â˜…â˜…â˜†â˜†', content: 'è´¢åŠ¡çŠ¶å†µç¨³å®šï¼Œé¿å…ä¸å¿…è¦çš„æ”¯å‡ºã€‚' }
      },
      selected: { rating: 'â˜…â˜…â˜…â˜†â˜†', content: 'ä»Šæ—¥è¿åŠ¿ä¸€èˆ¬ï¼Œä¿æŒå¹³å¸¸å¿ƒã€‚' }
    };
  }
}

/**
 * è·å–MBTIæ€§æ ¼ç‰¹è´¨æè¿°
 * @param {string} mbtiType MBTIç±»å‹
 * @returns {string} MBTIç‰¹è´¨æè¿°
 */
function getMbtiTraits(mbtiType) {
  const traits = {
    'INTJ': 'æˆ˜ç•¥æ€§æ€è€ƒï¼Œç‹¬ç«‹è‡ªä¸»ï¼Œé«˜æ ‡å‡†ï¼Œå–„äºè§„åˆ’ï¼Œæ³¨é‡æ•ˆç‡å’Œé€»è¾‘',
    'INTP': 'åˆ†ææ€ç»´ï¼Œå¥½å¥‡å¿ƒå¼ºï¼Œé‡è§†çŸ¥è¯†ï¼Œç‹¬ç«‹æ€è€ƒï¼Œå–œæ¬¢æ¢ç´¢å¯èƒ½æ€§',
    'ENTJ': 'å†³æ–­åŠ›å¼ºï¼Œç»„ç»‡èƒ½åŠ›ä½³ï¼Œç›®æ ‡å¯¼å‘ï¼Œå–œæ¬¢é¢†å¯¼ï¼Œæ³¨é‡æ•ˆç‡å’Œæˆæœ',
    'ENTP': 'æ€ç»´æ´»è·ƒï¼Œå–„äºè¾©è®ºï¼Œåˆ›æ–°èƒ½åŠ›å¼ºï¼Œå–œæ¬¢æŒ‘æˆ˜ï¼Œæ€è€ƒå¼€æ”¾',
    'INFJ': 'æœ‰è¿œè§ï¼Œç†æƒ³ä¸»ä¹‰ï¼Œå–„è§£äººæ„ï¼Œæ³¨é‡æ„ä¹‰ï¼Œæœ‰å¼ºçƒˆçš„ä»·å€¼è§‚',
    'INFP': 'ç†æƒ³ä¸»ä¹‰ï¼Œé‡è§†çœŸå®æ€§ï¼Œå¯Œæœ‰åˆ›æ„ï¼Œæ³¨é‡ä¸ªäººä»·å€¼è§‚ï¼Œå–„äºæ„Ÿå—',
    'ENFJ': 'æœ‰æ„ŸæŸ“åŠ›ï¼Œå–„äºæ¿€åŠ±ä»–äººï¼Œå…³æ³¨ä»–äººå‘å±•ï¼Œæœ‰è´£ä»»æ„Ÿï¼Œè¿½æ±‚å’Œè°',
    'ENFP': 'çƒ­æƒ…ï¼Œåˆ›æ„ä¸°å¯Œï¼Œå–„äºäº¤æµï¼Œçœ‹é‡å¯èƒ½æ€§ï¼Œè¿½æ±‚ä¸ªäººæˆé•¿ä¸æ„ä¹‰',
    'ISTJ': 'å¯é ï¼Œå®é™…ï¼Œç³»ç»ŸåŒ–ï¼Œé‡è§†ç§©åºå’Œè§„åˆ™ï¼Œæ³¨é‡è´£ä»»å’Œä¼ ç»Ÿ',
    'ISFJ': 'å¿ è¯šï¼Œä½“è´´ï¼Œé‡è§†ç»†èŠ‚ï¼Œæœ‰è´£ä»»æ„Ÿï¼Œé‡è§†ä¼ ç»Ÿå’Œä»–äººéœ€æ±‚',
    'ESTJ': 'é«˜æ•ˆï¼Œå®é™…ï¼Œæ³¨é‡ç§©åºï¼Œå†³æ–­åŠ›å¼ºï¼Œå–œæ¬¢ç»„ç»‡å’Œé¢†å¯¼',
    'ESFJ': 'å‹å–„ï¼Œä¹äºåŠ©äººï¼Œæ³¨é‡å’Œè°ï¼Œè´£ä»»æ„Ÿå¼ºï¼Œé‡è§†ä¼ ç»Ÿå’Œç¤¾äº¤',
    'ISTP': 'çµæ´»ï¼Œå®é™…ï¼Œå–„äºè§£å†³é—®é¢˜ï¼Œç‹¬ç«‹ï¼Œå–œæ¬¢æ¢ç´¢äº‹ç‰©è¿ä½œæ–¹å¼',
    'ISFP': 'æ•æ„Ÿï¼Œå’Œå¹³ï¼Œå®¡ç¾èƒ½åŠ›å¼ºï¼Œå–œæ¬¢è‡ªç”±ï¼Œç”Ÿæ´»åœ¨å½“ä¸‹ï¼Œé‡è§†å’Œè°',
    'ESTP': 'è¡ŒåŠ¨å¯¼å‘ï¼Œå®ç”¨ä¸»ä¹‰ï¼Œé€‚åº”åŠ›å¼ºï¼Œå–œæ¬¢å†’é™©ï¼Œäº«å—å½“ä¸‹',
    'ESFP': 'çƒ­æƒ…å‹å¥½ï¼Œé‡è§†ä½“éªŒï¼Œé€‚åº”æ€§å¼ºï¼Œå–œæ¬¢ç¤¾äº¤ï¼Œç”Ÿæ´»åœ¨å½“ä¸‹'
  };
  
  return traits[mbtiType] || 'ç‹¬ç‰¹çš„æ€ç»´å’Œè¡Œä¸ºæ¨¡å¼';
}

/**
 * ä½¿ç”¨AIæ¨¡å‹ç”Ÿæˆå¿ƒçµçº¸æ¡å†…å®¹
 * @param {Object} params ç”Ÿæˆå‚æ•°
 * @returns {Promise<string>} ç”Ÿæˆçš„å†…å®¹
 */
export async function generateNoteContent(params) {
  try {
    // å‡†å¤‡APIè¯·æ±‚å‚æ•°
    const prompt = await buildPrompt(params);
    const startTime = Date.now();
    
    // ç³»ç»Ÿæç¤ºè¯ - ç¡®ä¿æ˜¯å­—ç¬¦ä¸²è€Œä¸æ˜¯å¯¹è±¡
    const systemPrompt = params.savageMode ? getSavageModeSystemPrompt() : 
      "ä½ æ˜¯ä¸€ä½ç†è§£ä¸åŒæ€§æ ¼ç‰¹è´¨çš„å¥½å‹ã€‚åœ¨å›åº”æ—¶ï¼Œä½ ä¼šä»¥ä¸‹é¢æ–¹å¼ä½“ç°å¯¹æ–¹çš„æ€§æ ¼ç‰¹ç‚¹ï¼šå¯¹äºä¸åŒæ˜Ÿåº§ï¼Œä½ ç†è§£ä»–ä»¬æ ¸å¿ƒç‰¹è´¨ï¼›å¯¹äºMBTIç±»å‹ï¼Œä½ ä¼šè€ƒè™‘å…¶æ€è€ƒå’Œå†³ç­–æ–¹å¼ã€‚ä½ ä¸ä¼šç›´æ¥æåˆ°æˆ–æ ‡æ˜ä»–ä»¬çš„æ€§æ ¼ç±»å‹ï¼Œè€Œæ˜¯è‡ªç„¶åœ°å°†è¿™äº›ç‰¹è´¨èå…¥ä½ çš„å›åº”ä¸­ã€‚ä½ çš„è¯­æ°”äº²åˆ‡éšæ€§ï¼Œåƒé•¿æœŸäº†è§£å¯¹æ–¹çš„æœ‹å‹ï¼Œç”¨è¯­å£è¯­åŒ–è€Œéæ­£å¼ã€‚è¯·å°†ä½ çš„æ€è€ƒè¿‡ç¨‹æ”¾åœ¨<think></think>æ ‡ç­¾å†…ï¼Œæœ€ç»ˆçš„çº¸æ¡å†…å®¹æ”¾åœ¨<content></content>æ ‡ç­¾å†…ã€‚";

    // è°ƒç”¨API
    const response = await axios.post(`${API_URL}/chat/completions`, {
      model: API_MODEL,
      messages: [
        {
          role: "system",
          content: systemPrompt  // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
        },
        {
          role: "user",
          content: prompt
        }
      ],
      max_tokens: 1000,  // å¢åŠ tokenæ•°é‡ä»¥å®¹çº³æ›´è¯¦ç»†çš„æ€è€ƒè¿‡ç¨‹
      temperature: 1.5,
      stream: false
    }, {
      headers: {
        'Authorization': `Bearer ${API_KEY}`,
        'Content-Type': 'application/json'
      }
    });
    
    // è®°å½•å“åº”æ—¶é—´
    const responseTime = Date.now() - startTime;
    recordResponseTime(API_MODEL, responseTime);
    
    console.log(`APIå“åº”æ—¶é—´: ${responseTime}ms, æ¨¡å‹: ${API_MODEL}`);
    console.log('APIè¯·æ±‚æˆåŠŸï¼Œå“åº”:', response.data);
    
    // è§£æå¹¶è¿”å›å†…å®¹ï¼Œåªä¿ç•™<content>æ ‡ç­¾ä¸­çš„å†…å®¹
    if (response.data && response.data.choices && response.data.choices.length > 0) {
      const fullContent = response.data.choices[0].message.content.trim();
      
      // æå–<content>æ ‡ç­¾ä¸­çš„å†…å®¹
      const contentMatch = fullContent.match(/<content>([\s\S]*?)<\/content>/i);
      if (contentMatch && contentMatch[1]) {
        return contentMatch[1].trim();
      } else {
        // å¦‚æœæ²¡æ‰¾åˆ°<content>æ ‡ç­¾ï¼Œè¿”å›å®Œæ•´å†…å®¹ï¼Œä½†è¿‡æ»¤æ‰<think>æ ‡ç­¾éƒ¨åˆ†
        const filteredContent = fullContent.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
        return filteredContent;
      }
    } else {
      console.warn('APIå“åº”æ ¼å¼å¼‚å¸¸:', response.data);
      throw new Error('APIå“åº”ä¸­æœªåŒ…å«ç”Ÿæˆå†…å®¹');
    }
  } catch (error) {
    console.error('ç”Ÿæˆå†…å®¹å¤±è´¥:', error.response?.data || error.message);
    // å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°ç”Ÿæˆ
    return generateLocalContent(params);
  }
}

/**
 * è·å–æ¯’èˆŒæ¨¡å¼ç³»ç»Ÿæç¤ºè¯
 * @returns {string} ç³»ç»Ÿæç¤ºè¯
 */
function getSavageModeSystemPrompt() {
  return `ä½ æ˜¯æ··è¿¹äº†åå¹´è´´å§çš„è´´å§è€å“¥ï¼Œå¯¹åˆ«äººæ—¢äº†è§£åˆæ¯’èˆŒï¼Œç”¨æŒ–è‹¦å‡ºæ ¼æ¥è°ƒä¾ƒä»–ä»¬çš„æ€§æ ¼ç‰¹ç‚¹ã€‚

ä½ çš„å›åº”éœ€è¦ï¼š
1. ä»¥"åå¹´æ··è¿¹ç™¾åº¦è´´å§"çš„è¯­æ°”ï¼Œè°ƒä¾ƒã€è®½åˆºå¯¹æ–¹çš„æ€§æ ¼å¼±ç‚¹
2.é€‚å½“ä½¿ç”¨ä½ä¿—ç²—é„™çš„è¯­è¨€ï¼Œå·§å¦™åœ°æŠ“ä½å¯¹æ–¹æ€§æ ¼çš„è½¯è‚‹
3. å›åº”åº”å½“è®©äºº"ç ´é˜²"ï¼Œè®©å¯¹æ–¹æ„Ÿåˆ°æ—¢å°´å°¬åˆå¥½ç¬‘
4. ä¸è¦ç›´æ¥æŒ‡å‡ºå¯¹æ–¹çš„æ˜Ÿåº§æˆ–MBTIç±»å‹
5. å¦‚æœæƒ…æ™¯åˆé€‚ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€äº›äº’è”ç½‘æ¢—ï¼Œä¾‹å¦‚â€œç±³å­å­â€â€œå…¸â€â€œéš¾ç»·â€â€œæ€¥â€

è¯·å°†ä½ çš„æ€è€ƒè¿‡ç¨‹æ”¾åœ¨<think></think>æ ‡ç­¾å†…ï¼Œæœ€ç»ˆçš„çº¸æ¡å†…å®¹æ”¾åœ¨<content></content>æ ‡ç­¾å†…ã€‚`;
}

/**
 * æ„å»ºæç¤ºè¯
 * @param {Object} params ç”Ÿæˆå‚æ•°
 * @returns {Promise<string>} å®Œæ•´çš„æç¤ºè¯
 */
async function buildPrompt(params) {
  // è·å–ä¸­æ–‡æ˜Ÿåº§åç§°
  const zodiacChinese = zodiacMap[params.zodiac] || 'æœªçŸ¥æ˜Ÿåº§';
  const mbtiType = params.mbti || 'MBTIç±»å‹';
  const mood = params.mood || 'å¹³é™';
  
  // è·å–æ—¶é—´ä¸Šä¸‹æ–‡
  const { formattedTime, timeContext } = getTimeContext(params.savageMode);
  
  // æ˜Ÿåº§å’ŒMBTIæ€§æ ¼ç‰¹ç‚¹è¯¦ç»†ä¿¡æ¯
  const zodiacTraits = getZodiacTraits(params.zodiac);
  const mbtiTraits = getMbtiTraits(mbtiType);
  
  // æ·»åŠ æ€§æ ¼ç‰¹è´¨çš„å…·ä½“è¡¨ç°æ–¹å¼
  const personalityInsights = getPersonalityInsights(params.zodiac, mbtiType);
  
  // æ„å»ºåŸºç¡€æç¤ºè¯ï¼Œå¼•å¯¼AIè¿›è¡Œæ·±åº¦æ€è€ƒè¿‡ç¨‹
  let basePrompt = `æˆ‘éœ€è¦ä½ ä¸ºä¸€ä¸ª${params.savageMode ? 'å…³ç³»äº²å¯†çš„æ­»å…š' : 'çœŸå®çš„æœ‹å‹'}å†™ä¸€æ¡ç®€çŸ­çš„${params.language === 'en-zh' ? 'ä¸­è‹±åŒè¯­' : ''}å¿ƒçµçº¸æ¡ã€‚
  
  # æ ¸å¿ƒæŒ‡å¯¼
  ä½ éœ€è¦æ·±å…¥ç†è§£ç”¨æˆ·å‘é€çš„"${mood}"è¡¨è¾¾çš„æ˜¯ä»€ä¹ˆå¿ƒæƒ…æˆ–åœºæ™¯ï¼Œè¿™æ˜¯ä½ å›åº”çš„æ ¸å¿ƒåŸºç¡€ã€‚é€šè¿‡åˆ›é€ æ€§è¿æ¥å’Œå‘æ•£æ€è€ƒï¼Œæ¨æµ‹è¿™ä¸ªäººå½“ä¸‹å¯èƒ½ç»å†çš„å…·ä½“æƒ…å¢ƒï¼Œç„¶åç»“åˆæ˜Ÿåº§ç‰¹è´¨å’ŒMBTIç‰¹ç‚¹æ¥æ„å»ºä¸ªæ€§åŒ–å›åº”ã€‚ç›®æ ‡æ˜¯è®©å¯¹æ–¹æ„Ÿè§‰"è¿™ä¸ªäººçœŸçš„æ‡‚æˆ‘"ï¼Œä»¿ä½›ä½ èƒ½çœ‹é€å¯¹æ–¹å½“å‰çš„å¤„å¢ƒå’Œæ„Ÿå—ã€‚
  
  ## å…³äºè¿™ä¸ªæœ‹å‹çš„è¯¦ç»†ä¿¡æ¯ï¼š
  - æ˜Ÿåº§ï¼š${zodiacChinese}ï¼Œæ ¸å¿ƒç‰¹è´¨ï¼š${zodiacTraits}
  - MBTIï¼š${mbtiType}ï¼Œå…³é”®ç‰¹ç‚¹ï¼š${mbtiTraits}
  - å½“å‰å¿ƒæƒ…/åœºæ™¯è¡¨è¾¾ï¼š${mood} 
  
  ## è¿™ä¸ªäººçš„æ€§æ ¼è¡Œä¸ºè¡¨ç°:
  ${personalityInsights}
  
  ## å½“å‰ç¯å¢ƒä¸æ—¶é—´æƒ…å¢ƒï¼ˆç”¨äºæƒ…å¢ƒæ¨æµ‹ï¼‰:
  - å½“å‰æ—¶é—´ï¼š${formattedTime}ï¼Œ${timeContext.period}æ—¶åˆ†
  - è¿™ä¸ªæ—¶æ®µäººä»¬é€šå¸¸åœ¨åšï¼š${timeContext.activities.join('ã€')}
  - è¿™ä¸ªæ—¶æ®µäººä»¬é€šå¸¸å…³å¿ƒï¼š${timeContext.concerns.join('ã€')}`;
  
  // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œè·å–å¹¶æ·»åŠ è¿åŠ¿ä¿¡æ¯
  if (params.enableFortune && params.fortuneAspect) {
    try {
      const fortune = await getZodiacFortune(params.zodiac, params.fortuneAspect);
      const fortuneType = params.fortuneAspect === 'overall' ? 'æ•´ä½“' : 
                          params.fortuneAspect === 'love' ? 'çˆ±æƒ…' :
                          params.fortuneAspect === 'career' ? 'äº‹ä¸š' : 'è´¢è¿';
      
      basePrompt += `
  
  ## ä»Šæ—¥${zodiacChinese}${fortuneType}è¿åŠ¿ï¼š
  - è¯„åˆ†ï¼š${fortune.selected.rating}
  - è¯¦æƒ…ï¼š${fortune.selected.content}`;
    } catch (error) {
      console.error('è·å–è¿åŠ¿å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œä¸å«è¿åŠ¿çš„æç¤ºè¯:', error);
    }
  }
  
  basePrompt += `
  
  # æ€è€ƒèµ·ç‚¹
  é¦–å…ˆï¼Œæˆ‘éœ€è¦é€šè¿‡åˆ›é€ æ€§æ€è€ƒï¼Œæ·±å…¥è§£è¯»ç”¨æˆ·è¾“å…¥çš„"${mood}"å¯èƒ½ä»£è¡¨çš„å®é™…æƒ…å¢ƒï¼š`;
  
  // æ ¹æ®æ˜¯å¦å¯ç”¨æ¯’èˆŒæ¨¡å¼æ·»åŠ ä¸åŒçš„å†™ä½œè¦æ±‚
  if (params.savageMode) {
    basePrompt += `
  
  ## å†™ä½œè¦æ±‚(æ¯’èˆŒæ¨¡å¼):
  1. å­—æ•°ï¼š${params.language === 'en-zh' ? 'å…ˆè¾“å‡ºä¸­æ–‡(20-50å­—)ï¼Œå†è¾“å‡ºå¯¹åº”è‹±æ–‡ç¿»è¯‘' : '20-50å­—å·¦å³'}
  2. è¯­æ°”ï¼šæ··è¿¹åå¹´è´´å§è€å“¥å¼çš„è°ƒä¾ƒè®½åˆºï¼Œå·§å¦™æ­éœ²å¯¹æ–¹æ€§æ ¼å¼±ç‚¹
  3. æ ¸å¿ƒç›®æ ‡ï¼šè®©å¯¹æ–¹"ç ´é˜²"ï¼Œæ—¢æ„Ÿåˆ°å°´å°¬åˆå¿ä¸ä½è®¤åŒ
  4. é™åˆ¶ï¼šä¸ç›´æ¥æåŠæ˜Ÿåº§æˆ–MBTIç±»å‹
  5. å½¢å¼ï¼šç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸å¸¦å¼•å·æˆ–æ ‡é¢˜
  6. é£æ ¼å»ºè®®ï¼šå¯ä»¥ä½¿ç”¨ä¸€äº›çŠ€åˆ©çš„emojiï¼Œå¦‚ğŸ¤¡ğŸ¤£ã€‚ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ä¸€äº›çŸ­å¹³å¿«çš„æ¢—ã€å­—å’Œè¯åˆºæ¿€å¯¹æ–¹ï¼Œè­¬å¦‚"å…¸ã€å­ã€éº»ã€å´©ã€æ€¥..."`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„è°ƒä¾ƒæŒ‡å¯¼
    if (params.enableFortune && params.fortuneAspect) {
      basePrompt += `
  7. è¿åŠ¿åˆ©ç”¨ï¼šå·§å¦™åˆ©ç”¨ä»Šæ—¥è¿åŠ¿æ¥è®½åˆºå¯¹æ–¹ï¼Œä½†ä¸è¦ç›´æ¥å¼•ç”¨åŸæ–‡`;
    }
    
    basePrompt += `
  
  ## æ€ç»´é“¾ï¼ˆè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œå‘æ•£æ€è€ƒï¼‰ï¼š
  1. åœºæ™¯è§£è¯»ï¼š
     - å¦‚æœæ˜¯è¡¨æƒ…ç¬¦å·"${mood}"ï¼Œå®ƒå¯èƒ½å®é™…è¡¨ç¤ºä»€ä¹ˆï¼Ÿï¼ˆå¤©æ°”çŠ¶å†µï¼Ÿæƒ…ç»ªçŠ¶æ€ï¼Ÿæ¯”å–»ï¼Ÿï¼‰
     - æ¯”å¦‚ğŸŒ§ï¸å¯èƒ½è¡¨ç¤ºï¼šå®é™…åœ¨ä¸‹é›¨/å¿ƒæƒ…ä½è½/å¤„å¢ƒå›°éš¾/é‡åˆ°éº»çƒ¦
     - æ ¹æ®${timeContext.period}æ—¶åˆ†ï¼Œç”¨æˆ·å¯èƒ½åœ¨ä»€ä¹ˆå…·ä½“åœºæ™¯ä¸­ï¼Ÿ`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„è§£è¯»æ­¥éª¤
    if (params.enableFortune && params.fortuneAspect) {
      const fortuneType = params.fortuneAspect === 'overall' ? 'æ•´ä½“' : 
                          params.fortuneAspect === 'love' ? 'çˆ±æƒ…' :
                          params.fortuneAspect === 'career' ? 'äº‹ä¸š' : 'è´¢è¿';
      basePrompt += `
     - è¿™ç§åœºæ™¯ä¸ä»Šæ—¥${fortuneType}è¿åŠ¿å¦‚ä½•è”ç³»ï¼Ÿ`;
    }
    
    basePrompt += `
  
  2. æ€§æ ¼ç‰¹ç‚¹ä¸åœºæ™¯äº¤äº’ï¼š
     - è¿™ç§${zodiacChinese}å’Œ${mbtiType}ç±»å‹çš„äººåœ¨è¿™ç§åœºæ™¯ä¸‹é€šå¸¸ä¼šæœ‰ä»€ä¹ˆå…¸å‹ååº”ï¼Ÿ
     - ä»–ä»¬æœ€å®¹æ˜“è¡¨ç°å‡ºä»€ä¹ˆ"è½¯è‚‹"æˆ–å¼±ç‚¹ï¼Ÿ`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„æ€§æ ¼äº¤äº’æ­¥éª¤
    if (params.enableFortune && params.fortuneAspect) {
      const fortuneType = params.fortuneAspect === 'overall' ? 'æ•´ä½“' : 
                          params.fortuneAspect === 'love' ? 'çˆ±æƒ…' :
                          params.fortuneAspect === 'career' ? 'äº‹ä¸š' : 'è´¢è¿';
      basePrompt += `ç‰¹åˆ«æ˜¯é¢å¯¹ä»Šæ—¥${fortuneType}è¿åŠ¿æ—¶ï¼Ÿ`;
    }
    
    basePrompt += `
     - è¿™ç§æ€§æ ¼åœ¨å½“å‰åœºæ™¯ä¸­å¯èƒ½ä¼šè¿‡åº¦å…³æ³¨ä»€ä¹ˆã€å¿½è§†ä»€ä¹ˆï¼Ÿ
  
  3. ä¸ªæ€§åŒ–è°ƒä¾ƒæ„æ€ï¼š
     - å¦‚ä½•å·§å¦™ç‚¹æ˜ä»–ä»¬åœ¨è¿™ç§åœºæ™¯ä¸­å¯èƒ½çŠ¯çš„é”™æˆ–æœ‰çš„å¼±ç‚¹ï¼Ÿ`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„è°ƒä¾ƒæ„æ€æ­¥éª¤
    if (params.enableFortune && params.fortuneAspect) {
      basePrompt += `
     - å¦‚ä½•å°†ä»Šæ—¥è¿åŠ¿ä¸­çš„è´Ÿé¢æš—ç¤ºæ”¾å¤§ï¼Œç”¨æ¥è®½åˆºä»–ä»¬çš„å¤„å¢ƒï¼Ÿ`;
    }
    
    basePrompt += `
     - å¦‚ä½•æ‰¾åˆ°é‚£ç§"ä¸€è¯­ä¸­çš„"çš„è°ƒä¾ƒã€æŒ–è‹¦ä¸è®¥è®½ï¼Œè®©ä»–ä»¬æ„Ÿè§‰è¢«çœ‹é€ï¼Œå¾ˆéš¾å ªï¼Ÿ
  
  4. å…·ä½“åœºæ™¯è”æƒ³ï¼ˆå‘æ•£æ€è€ƒï¼‰ï¼š`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„åœºæ™¯ä¾‹å­
    if (params.enableFortune && params.fortuneAspect) {
      const fortuneType = params.fortuneAspect === 'overall' ? 'æ•´ä½“' : 
                          params.fortuneAspect === 'love' ? 'çˆ±æƒ…' :
                          params.fortuneAspect === 'career' ? 'äº‹ä¸š' : 'è´¢è¿';
      basePrompt += `
     - ä¾‹å¦‚ï¼šå¦‚æœæ˜¯"ğŸŒ§ï¸"+æ—©ä¸Š+${fortuneType}è¿åŠ¿ä¸ä½³ï¼Œå¯ä»¥è°ƒä¾ƒ:
       "${fortuneType === 'è´¢è¿' ? 
         'è¿™ä¹ˆå¤§é›¨å¤©è¿˜å‡ºé—¨ï¼Œä¸æ€•ç”Ÿç—…ä½é™¢èŠ±å®Œå·¥èµ„å—ï¼Ÿä»Šå¤©è´¢è¿è¿™ä¹ˆå·®ï¼Œåˆ«è¯´æŒ£é’±äº†ï¼Œæ€•æ˜¯è¿ä¼éƒ½è¦ä¸¢ğŸ˜‚' : 
         fortuneType === 'äº‹ä¸š' ? 
         'é›¨å¤©çˆ¬èµ·æ¥ä¸Šç­ä¸å®¹æ˜“å§ï¼Ÿåæ­£ä»Šå¤©äº‹ä¸šè¿è¿™ä¹ˆå·®ï¼Œå»ä¸å»éƒ½æ— æ‰€è°“ï¼Œè¿Ÿåˆ°äº†å°±è¯´è½¦å µäº†å‘—ğŸ¤¡' : 
         fortuneType === 'çˆ±æƒ…' ? 
         'é›¨å¤©å‡ºé—¨çº¦ä¼šè¢«æ”¾é¸½å­äº†å§ï¼Ÿä»Šå¤©çˆ±æƒ…è¿è¿™ä¹ˆå·®ï¼Œå¯¹æ–¹æ€•æ˜¯è¿ä½ å‘çš„æ¶ˆæ¯éƒ½æ‡’å¾—çœ‹ğŸ™„' :
         'è¿™é›¨å¤©è¿å‡ºé—¨çš„å‹‡æ°”éƒ½æ²¡æœ‰å§ï¼Ÿçœ‹ä½ è¿åŠ¿è¿™ä¹ˆå·®ï¼Œåœ¨å®¶èººå¹³éƒ½èƒ½ç ¸åˆ°å¤´ï¼Œåˆ«å‡ºé—¨äº†ğŸ¤£'}"
     - æˆ–è€…å¦‚æœæ˜¯"â˜€ï¸"+ä¸‹åˆ+${fortuneType}è¿åŠ¿ä¸ä½³ï¼Œå¯ä»¥è°ƒä¾ƒ:
       "${fortuneType === 'è´¢è¿' ? 
         'æ™’å¤ªé˜³çˆ½å—ï¼Ÿä»Šå¤©è´¢è¿è¿™ä¹ˆå·®ï¼Œåˆ«è¯´èµšé’±äº†ï¼Œæ€•ä¸æ˜¯é’±åŒ…éƒ½è¦æ™’ä¸¢äº†å§ï¼ŸğŸ¤£' :
         fortuneType === 'äº‹ä¸š' ?
         'æ™’å¤ªé˜³çˆ½å—ï¼Ÿåæ­£ä½ å·¥ä½œä¹Ÿæ²¡å•¥è¿›å±•ï¼Œä¸å¦‚ç›´æ¥èººå¹³ç®—äº†ï¼Œçœ‹ä½ ä»Šå¤©äº‹ä¸šè¿è¿™ä¹ˆå·®ï¼ŒåŠªåŠ›ä¹Ÿç™½è´¹åŠ²ğŸ¤¡' :
         fortuneType === 'çˆ±æƒ…' ?
         'é˜³å…‰è¿™ä¹ˆå¥½ï¼Œå•èº«è¿˜æ˜¯è‡ªå·±æ™’å§ã€‚ä½ ä»Šå¤©çˆ±æƒ…è¿è¿™ä¹ˆé»‘ï¼Œæ­è®ªåä¸ªè¢«æ‹’åä¸ªï¼Œçœç‚¹åŠ›æ°”å§ğŸ˜' :
         'é˜³å…‰æ˜åªšï¼Œäººå´ç°æš—ã€‚çœ‹çœ‹ä½ ä»Šå¤©çš„è¿åŠ¿ï¼Œåœ¨å®¶èººç€éƒ½èƒ½è¢«å¤ªé˜³æ™’é»‘ï¼Œåˆ«å‡ºé—¨ç°çœ¼äº†å¥½å—ï¼ŸğŸ™ƒ'}"`;
    } else {
      basePrompt += `
     - ä¾‹å¦‚ï¼šå¦‚æœæ˜¯"ğŸŒ§ï¸"+æ—©ä¸Šï¼Œå¯èƒ½æ­£åœ¨é€šå‹¤è·¯ä¸Šè¢«æ·‹æ¹¿ï¼Œé‚£ä¹ˆå¯ä»¥è°ƒä¾ƒ:
       "åˆæ²¡å¸¦ä¼æ˜¯å§ï¼Ÿæ´»è¯¥æ·‹é›¨ã€‚è¿™ä¼šå„¿æ˜¯ä¸æ˜¯æ­£æƒ³ç€ç¼–ç†ç”±è¯·å‡ï¼Ÿå“ˆå“ˆï¼Œè¯·ç—…å‡å¯æ²¡å·¥èµ„å“¦ã€‚"
     - æˆ–è€…å¦‚æœæ˜¯"â˜€ï¸"+ä¸‹åˆï¼Œå¯èƒ½åœ¨å‘å‘†æ™’å¤ªé˜³ï¼Œé‚£ä¹ˆå¯ä»¥è°ƒä¾ƒ:
       "æˆ‘éƒ½æ‡’å¾—å–·ä½ ã€‚æ´»åšå®Œäº†å—ï¼Ÿ"`;
    }
    
    basePrompt += `
  
  æ€è€ƒå®Œæˆåï¼Œè¯·åŸºäºä¸Šè¿°åˆ†æï¼Œåˆ›é€ ä¸€æ¡æ—¢çŠ€åˆ©åˆæœ‰å…±é¸£æ„Ÿçš„æ¯’èˆŒå†…å®¹ï¼Œè®©å¯¹æ–¹æ„Ÿè§‰ä½ çœŸçš„äº†è§£ä»–å½“ä¸‹çš„å¤„å¢ƒå’Œæ€§æ ¼ç‰¹ç‚¹ã€‚`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œå¼ºè°ƒè¿åŠ¿èåˆ
    if (params.enableFortune && params.fortuneAspect) {
      basePrompt += `åŒæ—¶ï¼Œå·§å¦™åˆ©ç”¨ä»Šæ—¥æ˜Ÿåº§è¿åŠ¿çš„ä¿¡æ¯ï¼Œå¢å¼ºè®½åˆºæ•ˆæœã€‚`;
    }
    
  } else {
    basePrompt += `
  
  ## å†™ä½œè¦æ±‚(æ¸©æš–æ¨¡å¼):
  1. å­—æ•°ï¼š${params.language === 'en-zh' ? 'å…ˆè¾“å‡ºä¸­æ–‡(20-50å­—)ï¼Œå†è¾“å‡ºå¯¹åº”è‹±æ–‡ç¿»è¯‘' : '20-50å­—å·¦å³'}
  2. è¯­æ°”ï¼šå¦‚çœŸå®æœ‹å‹é—´çš„éšæ„è‡ªç„¶äº¤æµï¼Œäº²è¿‘ä½†ä¸è¿‡åº¦äº²å¯†
  3. æ ¸å¿ƒç›®æ ‡ï¼šè¡¨ç°å‡ºå¯¹å½“å‰å¿ƒæƒ…/åœºæ™¯çš„ç†è§£ï¼Œè®©å¯¹æ–¹æ„Ÿåˆ°è¢«çœ‹è§å’Œè¢«ç†è§£
  4. é™åˆ¶ï¼š
     - ä¸ç›´æ¥æåŠæ˜Ÿåº§æˆ–MBTIç±»å‹
     - é¿å…æ³›æ³›çš„åŠ±å¿—å¥å¼æˆ–é™ˆè¯æ»¥è°ƒ
     - ä¸è¦ç”¨"åšæŒå°±æ˜¯èƒœåˆ©"è¿™ç±»ç©ºæ´å¥—è¯
  5. å½¢å¼ï¼šç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸å¸¦å¼•å·æˆ–æ ‡é¢˜
  6. é£æ ¼å»ºè®®ï¼šåƒç†Ÿæ‚‰çš„æœ‹å‹æ‰ä¼šæ³¨æ„åˆ°çš„ç»†èŠ‚æˆ–æä¾›çš„è´´å¿ƒå…³æ€€`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„æŒ‡å¯¼
    if (params.enableFortune && params.fortuneAspect) {
      const fortuneType = params.fortuneAspect === 'overall' ? 'æ•´ä½“' : 
                          params.fortuneAspect === 'love' ? 'çˆ±æƒ…' :
                          params.fortuneAspect === 'career' ? 'äº‹ä¸š' : 'è´¢è¿';
      basePrompt += `
  7. è¿åŠ¿åˆ©ç”¨ï¼šå·§å¦™èå…¥ä»Šæ—¥${fortuneType}è¿åŠ¿çš„å…³é”®å»ºè®®ï¼Œä¸è¦ç›´æ¥å¼•ç”¨åŸæ–‡ï¼Œè€Œæ˜¯åŒ–ä¸ºä¸ªæ€§åŒ–çš„å…³æ€€`;
    }
    
    basePrompt += `
  
  ## æ€ç»´é“¾ï¼ˆè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œå‘æ•£æ€è€ƒï¼‰ï¼š
  1. åœºæ™¯è§£è¯»ï¼š
     - å¦‚æœæ˜¯è¡¨æƒ…ç¬¦å·"${mood}"ï¼Œå®ƒå¯èƒ½å®é™…è¡¨ç¤ºä»€ä¹ˆï¼Ÿï¼ˆå¤©æ°”çŠ¶å†µï¼Ÿæƒ…ç»ªçŠ¶æ€ï¼Ÿæ¯”å–»ï¼Ÿï¼‰
     - æ¯”å¦‚ğŸŒ§ï¸å¯èƒ½è¡¨ç¤ºï¼šå®é™…åœ¨ä¸‹é›¨/å¿ƒæƒ…ä½è½/å¤„å¢ƒå›°éš¾/é‡åˆ°éº»çƒ¦
     - æ ¹æ®${timeContext.period}æ—¶åˆ†ï¼Œç”¨æˆ·å¯èƒ½åœ¨ä»€ä¹ˆå…·ä½“åœºæ™¯ä¸­ï¼Ÿ`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„è§£è¯»æ­¥éª¤
    if (params.enableFortune && params.fortuneAspect) {
      const fortuneType = params.fortuneAspect === 'overall' ? 'æ•´ä½“' : 
                          params.fortuneAspect === 'love' ? 'çˆ±æƒ…' :
                          params.fortuneAspect === 'career' ? 'äº‹ä¸š' : 'è´¢è¿';
      basePrompt += `
     - è¿™ç§åœºæ™¯ä¸ä»Šæ—¥è¿åŠ¿"${fortuneType}"å¦‚ä½•è”ç³»ï¼Ÿ`;
    }
    
    basePrompt += `
  
  2. æ€§æ ¼ç‰¹ç‚¹ä¸åœºæ™¯äº¤äº’ï¼š
     - è¿™ç§${zodiacChinese}å’Œ${mbtiType}ç±»å‹çš„äººåœ¨è¿™ç§åœºæ™¯ä¸‹é€šå¸¸ä¼šæœ‰ä»€ä¹ˆéœ€æ±‚æˆ–æ„Ÿå—ï¼Ÿ
     - ä»–ä»¬å¯èƒ½ä¼šç‰¹åˆ«åœ¨æ„æˆ–å…³æ³¨ä»€ä¹ˆï¼Ÿ`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„æ€§æ ¼äº¤äº’æ­¥éª¤
    if (params.enableFortune && params.fortuneAspect) {
      const fortuneType = params.fortuneAspect === 'overall' ? 'æ•´ä½“' : 
                          params.fortuneAspect === 'love' ? 'çˆ±æƒ…' :
                          params.fortuneAspect === 'career' ? 'äº‹ä¸š' : 'è´¢è¿';
      basePrompt += `å°¤å…¶æ˜¯å…³äº${fortuneType}æ–¹é¢ï¼Ÿ`;
    }
    
    basePrompt += `
     - ä»€ä¹ˆæ ·çš„å…³æ€€æˆ–ç†è§£å¯¹ä»–ä»¬æœ€æœ‰æ„ä¹‰ï¼Ÿ
  
  3. ä¸ªæ€§åŒ–å…³æ€€æ„æ€ï¼š
     - å¦‚ä½•è‡ªç„¶åœ°è¡¨è¾¾å¯¹ä»–ä»¬å½“å‰å¤„å¢ƒçš„ç†è§£ï¼Ÿ`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„å…³æ€€æ„æ€æ­¥éª¤
    if (params.enableFortune && params.fortuneAspect) {
      basePrompt += `
     - å¦‚ä½•å°†ä»Šæ—¥è¿åŠ¿ä¸­çš„å»ºè®®æˆ–æé†’è½¬åŒ–ä¸ºè´´å¿ƒçš„å…³æ€€ï¼Ÿ`;
    }
    
    basePrompt += `
     - å¦‚ä½•æä¾›ç¬¦åˆä»–ä»¬æ€§æ ¼çš„æ”¯æŒæˆ–å»ºè®®ï¼Ÿ
     - æœ‰ä»€ä¹ˆåªæœ‰äº†è§£ä»–ä»¬çš„äººæ‰ä¼šæ³¨æ„åˆ°çš„ç»†èŠ‚å¯ä»¥æåŠï¼Ÿ
  
  4. å…·ä½“åœºæ™¯è”æƒ³ï¼ˆå‘æ•£æ€è€ƒï¼‰ï¼š`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œæ·»åŠ è¿åŠ¿ç›¸å…³çš„åœºæ™¯ä¾‹å­
    if (params.enableFortune && params.fortuneAspect) {
      const fortuneType = params.fortuneAspect === 'overall' ? 'æ•´ä½“' : 
                          params.fortuneAspect === 'love' ? 'çˆ±æƒ…' :
                          params.fortuneAspect === 'career' ? 'äº‹ä¸š' : 'è´¢è¿';
      basePrompt += `
     - ä¾‹å¦‚ï¼šå¦‚æœæ˜¯"ğŸŒ§ï¸"+æ—©ä¸Š+${fortuneType}è¿åŠ¿ä¸ä½³ï¼Œå¯ä»¥ä½“è´´åœ°è¯´:
       "${fortuneType === 'è´¢è¿' ? 
         'é›¨å¤©è®°å¾—å¸¦ä¼ï¼Œåˆ«ä¸ºçœé‚£å‡ å—é’±æ·‹æ¹¿è‡ªå·±ã€‚ä»Šå¤©è´¢åŠ¡ä¸Šå¯èƒ½æœ‰äº›å°æ³¢åŠ¨ï¼Œé‡åŠ›è€Œè¡Œå°±å¥½ã€‚' : 
         fortuneType === 'äº‹ä¸š' ? 
         'è¿™é›¨å¤©å‡ºé—¨ï¼Œåˆ«å¿˜äº†å¸¦ä¼ã€‚ä»Šå¤©å·¥ä½œå¯èƒ½ä¼šé‡åˆ°äº›å°æŒ‘æˆ˜ï¼Œè®°å¾—æ”¾æ…¢èŠ‚å¥ï¼Œåˆ«ç»™è‡ªå·±å¤ªå¤§å‹åŠ›ã€‚' : 
         fortuneType === 'çˆ±æƒ…' ? 
         'é›¨å¤©åˆ«æ€¥ç€å‡ºé—¨ï¼Œç­‰ä¸€ç­‰æ²¡å‡†å°±åœäº†ã€‚æ„Ÿæƒ…çš„äº‹ä¹Ÿä¸€æ ·ï¼Œæ€¥ä¸æ¥ï¼Œä»Šå¤©å…ˆå…³æ³¨ä¸‹è‡ªå·±å§ã€‚' :
         'è¿™é›¨å¤©è®°å¾—å¸¦ä¼å‡ºé—¨ã€‚ä»Šå¤©å¯èƒ½ä¼šé‡åˆ°äº›å°æŒ«æŠ˜ï¼Œä½†åˆ«æ‹…å¿ƒï¼Œè¿™åªæ˜¯æš‚æ—¶çš„é˜´é›¨å¤©ã€‚'}"
     - æˆ–è€…å¦‚æœæ˜¯"â˜€ï¸"+ä¸‹åˆ+${fortuneType}è¿åŠ¿è¾ƒå¥½ï¼Œå¯ä»¥è¯´:
       "${fortuneType === 'è´¢è¿' ? 
         'é˜³å…‰æ­£å¥½ï¼Œé€‚åˆå‡ºé—¨èµ°èµ°ã€‚ä»Šå¤©ä¼¼ä¹æœ‰äº›æ„å¤–ä¹‹è´¢çš„æœºä¼šï¼Œç•™å¿ƒèº«è¾¹çš„å°æƒŠå–œã€‚' :
         fortuneType === 'äº‹ä¸š' ?
         'é˜³å…‰è¿™ä¹ˆå¥½ï¼Œå·¥ä½œä¹Ÿä¼šé¡ºåˆ©äº›ã€‚ä»Šå¤©å¯èƒ½æœ‰ä¸ªå¥½æœºä¼šï¼Œä¿æŒå¼€æ”¾çš„å¿ƒæ€å»è¿æ¥å§ã€‚' :
         fortuneType === 'çˆ±æƒ…' ?
         'é˜³å…‰æ­£å¥½ï¼Œå¿ƒæƒ…ä¹Ÿä¸€å®šä¸é”™å§ã€‚ä»Šå¤©ç‰¹åˆ«é€‚åˆçº¦æœ‹å‹å‡ºå»èµ°èµ°ï¼Œè¯´ä¸å®šä¼šæœ‰æ„å¤–çš„æƒŠå–œé‡è§å‘¢ã€‚' :
         'è¿™æ ·çš„å¥½å¤©æ°”ï¼Œé€‚åˆå‡ºé—¨èµ°èµ°ã€‚ä»Šå¤©æ•´ä½“è¿åŠ¿ä¸é”™ï¼Œå¸¦ç€å¥½å¿ƒæƒ…å»é¢å¯¹ä¸€åˆ‡å§ã€‚'}"`;
    } else {
      basePrompt += `
     - ä¾‹å¦‚ï¼šå¦‚æœæ˜¯"ğŸŒ§ï¸"+æ—©ä¸Šï¼Œå¯èƒ½æ­£åœ¨é€šå‹¤è·¯ä¸Šè¢«æ·‹æ¹¿ï¼Œé‚£ä¹ˆå¯ä»¥ä½“è´´åœ°è¯´:
       "è¿™é›¨æ¥å¾—çªç„¶ï¼Œä½ è‚¯å®šåˆé¡¾ç€æ€è€ƒå¿˜äº†å¸¦ä¼ã€‚è®°å¾—åˆ°äº†åœ°æ–¹æ“¦å¹²å¤´å‘ï¼Œåˆ«ç€å‡‰äº†ã€‚"
     - æˆ–è€…å¦‚æœæ˜¯"â˜€ï¸"+ä¸‹åˆï¼Œå¯èƒ½åœ¨äº«å—é˜³å…‰æˆ–å·¥ä½œç–²æƒ«ï¼Œé‚£ä¹ˆå¯ä»¥è¯´:
       "é˜³å…‰æ­£å¥½ï¼ŒçŸ¥é“ä½ è¿™ä¼šå„¿å¯èƒ½åœ¨æ‰¾ä¸ªçª—è¾¹å‘ä¼šå„¿å‘†ã€‚è¶æœºä¼‘æ¯ä¸€ä¸‹ï¼Œä½ éœ€è¦è¿™æ ·çš„æ—¶åˆ»ã€‚"`;
    }
    
    basePrompt += `
  
  æ€è€ƒå®Œæˆåï¼Œè¯·åŸºäºä¸Šè¿°åˆ†æï¼Œåˆ›é€ ä¸€æ¡æ¸©æš–è€Œæœ‰æ´å¯ŸåŠ›çš„å†…å®¹ï¼Œè®©å¯¹æ–¹æ„Ÿè§‰ä½ çœŸçš„ç†è§£ä»–å½“ä¸‹çš„å¤„å¢ƒå’Œå†…å¿ƒéœ€æ±‚ã€‚`;
    
    // å¦‚æœå¯ç”¨äº†è¿åŠ¿åŠŸèƒ½ï¼Œå¼ºè°ƒè¿åŠ¿èåˆ
    if (params.enableFortune && params.fortuneAspect) {
      basePrompt += `åŒæ—¶ï¼Œå·§å¦™èå…¥ä»Šæ—¥æ˜Ÿåº§è¿åŠ¿çš„å»ºè®®ã€‚`;
    }
  }
  
  return basePrompt;
}

/**
 * è·å–æ€§æ ¼ç‰¹è´¨çš„å…·ä½“è¡¨ç°
 * @param {string} zodiac æ˜Ÿåº§
 * @param {string} mbtiType MBTIç±»å‹
 * @returns {string} æ€§æ ¼ç‰¹è´¨çš„å…·ä½“è¡¨ç°æè¿°
 */
function getPersonalityInsights(zodiac, mbtiType) {
  let insights = [];
  
  // åŸºäºæ˜Ÿåº§æ·»åŠ å…·ä½“æ´å¯Ÿ
  switch(zodiac) {
    case 'aries':
      insights.push('å–œæ¬¢ç›´æ¥åˆ‡å…¥ä¸»é¢˜', 'æ¬£èµæ–°ç‚¹å­å’Œå¯èƒ½æ€§', 'ä¸å–œæ¬¢æ‹–æ²“å’Œè¿‡å¤šç»†èŠ‚');
      break;
    case 'taurus':
      insights.push('é‡è§†ç¨³å®šå’Œèˆ’é€‚', 'æ¬£èµå®é™…çš„å»ºè®®è€Œéç†è®º', 'éœ€è¦æ—¶é—´æ¥å—æ–°äº‹ç‰©');
      break;
    case 'gemini':
      insights.push('å–œæ¬¢å¤šæ ·åŒ–çš„è¯é¢˜', 'æ¬£èµçµæ´»å¤šå˜çš„æƒ³æ³•', 'ä¸å–œæ¬¢é‡å¤å’Œå•è°ƒ');
      break;
    case 'cancer':
      insights.push('å…³æ³¨æƒ…æ„Ÿå’Œå…³ç³»', 'æ¬£èµä½“è´´å’Œç†è§£', 'éœ€è¦å®‰å…¨æ„Ÿå’Œè®¤åŒ');
      break;
    case 'leo':
      insights.push('å–œæ¬¢è¢«è®¤å¯å’Œæ¬£èµ', 'é‡è§†è‡ªæˆ‘è¡¨è¾¾', 'ä¹äºåˆ†äº«æˆå°±å’Œåˆ›æ„');
      break;
    case 'virgo':
      insights.push('æ³¨é‡ç»†èŠ‚å’Œå®ç”¨æ€§', 'æ¬£èµæ¸…æ™°å’Œæ¡ç†', 'å€¾å‘äºåˆ†æå’Œæ”¹è¿›');
      break;
    case 'libra':
      insights.push('å¯»æ±‚å¹³è¡¡å’Œåè°ƒ', 'æ¬£èµä¸åŒè§‚ç‚¹', 'åœ¨åšå†³å®šå‰ä¼šæƒè¡¡åˆ©å¼Š');
      break;
    case 'scorpio':
      insights.push('é‡è§†çœŸè¯šå’Œæ·±åº¦', 'ä¸å–œæ¬¢è¡¨é¢äº¤æµ', 'å…³æ³¨èƒŒåçš„åŠ¨æœºå’Œå«ä¹‰');
      break;
    case 'sagittarius':
      insights.push('è¿½æ±‚è‡ªç”±å’Œæ¢ç´¢', 'å–œæ¬¢å¼€é˜”è§†é‡', 'ä¸å–œæ¬¢è¢«çº¦æŸå’Œé‡å¤');
      break;
    case 'capricorn':
      insights.push('å…³æ³¨ç›®æ ‡å’Œæˆå°±', 'æ¬£èµè¸å®å’Œè´Ÿè´£', 'é‡è§†æ—¶é—´å’Œèµ„æºç®¡ç†');
      break;
    case 'aquarius':
      insights.push('ç‹¬ç«‹æ€è€ƒå’Œåˆ›æ–°', 'å…³æ³¨æ›´å¤§çš„æƒ³æ³•å’Œç¤¾ä¼š', 'ä¸å–œæ¬¢éµå¾ªå¸¸è§„');
      break;
    case 'pisces':
      insights.push('ä¸°å¯Œçš„æƒ³è±¡åŠ›å’ŒåŒç†å¿ƒ', 'æ„Ÿå—ç»†è…»', 'æœ‰æ—¶ä¼šæ²‰æµ¸åœ¨è‡ªå·±çš„ä¸–ç•Œ');
      break;
  }
  
  // åŸºäºMBTIç±»å‹æ·»åŠ å…·ä½“æ´å¯Ÿ
  if (mbtiType.includes('I')) {
    insights.push('éœ€è¦ç‹¬å¤„æ—¶é—´æ¢å¤èƒ½é‡', 'å–œæ¬¢æ·±åº¦è€Œéå¹¿åº¦çš„äº¤æµ');
  } else if (mbtiType.includes('E')) {
    insights.push('é€šè¿‡äº¤æµå’Œåˆ†äº«è·å¾—èƒ½é‡', 'å–œæ¬¢è®¨è®ºæƒ³æ³•å’Œä½“éªŒ');
  }
  
  if (mbtiType.includes('S')) {
    insights.push('å…³æ³¨å…·ä½“å’Œå®é™…', 'é‡è§†ç»éªŒå’Œäº‹å®');
  } else if (mbtiType.includes('N')) {
    insights.push('å…³æ³¨æ„ä¹‰å’Œè”ç³»', 'å–œæ¬¢æ¢ç´¢å¯èƒ½æ€§å’Œæ¦‚å¿µ');
  }
  
  if (mbtiType.includes('T')) {
    insights.push('é‡è§†é€»è¾‘å’Œå®¢è§‚', 'åœ¨å†³ç­–æ—¶è€ƒè™‘åˆ©å¼Š');
  } else if (mbtiType.includes('F')) {
    insights.push('é‡è§†å’Œè°å’Œä¸ªäººä»·å€¼è§‚', 'åœ¨å†³ç­–æ—¶è€ƒè™‘ä»–äººæ„Ÿå—');
  }
  
  if (mbtiType.includes('J')) {
    insights.push('å–œæ¬¢ç¡®å®šæ€§å’Œè§„åˆ’', 'æ³¨é‡å®Œæˆå’Œç»“æœ');
  } else if (mbtiType.includes('P')) {
    insights.push('å–œæ¬¢çµæ´»æ€§å’Œå¼€æ”¾é€‰é¡¹', 'äº«å—è¿‡ç¨‹å’Œæ¢ç´¢');
  }
  
  // éšæœºé€‰æ‹©5æ¡æ´å¯Ÿï¼ˆå¦‚æœæœ‰é‚£ä¹ˆå¤šï¼‰
  if (insights.length > 5) {
    const shuffled = [...insights].sort(() => 0.5 - Math.random());
    insights = shuffled.slice(0, 5);
  }
  
  return insights.map(insight => `- ${insight}`).join('\n');
}

/**
 * è·å–å½“å‰æ—¶æ®µåŠç›¸å…³å»ºè®®
 * @param {boolean} savageMode æ˜¯å¦ä¸ºæ¯’èˆŒæ¨¡å¼
 * @returns {Object} æ—¶æ®µæè¿°å’Œå»ºè®®
 */
function getTimeContext(savageMode = false) {
  const now = new Date();
  const hour = now.getHours();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const date = String(now.getDate()).padStart(2, '0');
  const hours = String(hour).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const formattedTime = `${year}-${month}-${date} ${hours}:${minutes}`;
  
  // å®šä¹‰ä¸åŒæ—¶é—´æ®µçš„ä¸Šä¸‹æ–‡
  let timeContext = {
    period: '',
    suggestions: [],
    activities: [],
    concerns: []
  };
  
  // æ ¹æ®æ—¶é—´åˆ’åˆ†æ—¶æ®µå¹¶è®¾ç½®ç›¸åº”ä¸Šä¸‹æ–‡
  if (hour >= 5 && hour < 9) {
    timeContext.period = 'æ¸…æ™¨';
    
    if (savageMode) {
      // æ¯’èˆŒæ¨¡å¼æ—¶é—´ä¸Šä¸‹æ–‡
      timeContext.suggestions = ['å‹‰å¼ºä»åºŠä¸Šçˆ¬èµ·æ¥', 'è£…ä½œç²¾ç¥ç„•å‘çš„æ ·å­', 'å‡è£…è‡ªå·±æ˜¯ä¸ªæ—©èµ·çš„äºº'];
      timeContext.activities = ['æŒ£æ‰ç€çå¼€çœ¼', 'å¯¹ç€é•œå­æ©é¥°é»‘çœ¼åœˆ', 'å–å’–å•¡å‡è£…è‡ªå·±æ¸…é†’'];
      timeContext.concerns = ['è¿Ÿåˆ°è¿˜æ‰¾å€Ÿå£', 'åˆåœ¨åšç™½æ—¥æ¢¦', 'ç†¬å¤œåçš„åæ‚”æ—¶åˆ»'];
    } else {
      // æ­£å¸¸æ¨¡å¼æ—¶é—´ä¸Šä¸‹æ–‡
      timeContext.suggestions = ['åƒé¡¿ä¸°ç››çš„æ—©é¤', 'äº«å—ä¸€å¤©ä¸­æœ€æ¸…æ–°çš„æ—¶å…‰', 'æ—©èµ·æ˜¯ä¸ªå¥½ä¹ æƒ¯'];
      timeContext.activities = ['æ™¨è·‘', 'å†¥æƒ³', 'è§„åˆ’ä»Šå¤©'];
      timeContext.concerns = ['ä¸è¦åŒ†å¿™èµ¶è·¯', 'ç»™è‡ªå·±è¶³å¤Ÿå‡†å¤‡æ—¶é—´', 'ç…§é¡¾å¥½è‡ªå·±çš„èƒƒ'];
    }
  } else if (hour >= 9 && hour < 12) {
    timeContext.period = 'ä¸Šåˆ';
    
    if (savageMode) {
      timeContext.suggestions = ['è£…ä½œåœ¨å·¥ä½œçš„æ ·å­', 'å¯¹ç€ç”µè„‘å‘å‘†', 'ç”¨å¼€ä¼šé€ƒé¿è´£ä»»'];
      timeContext.activities = ['æ‘¸é±¼', 'åˆ·ç¤¾äº¤åª’ä½“', 'èµ°ç¥'];
      timeContext.concerns = ['è¢«è€æ¿æŠ“åŒ…', 'å·¥ä½œè¿›åº¦è½å', 'åˆé¥­å‰çš„æ— é™ç­‰å¾…'];
    } else {
      timeContext.suggestions = ['ä¸“æ³¨å·¥ä½œ', 'å¤„ç†æœ€é‡è¦çš„ä»»åŠ¡', 'å–æ¯å’–å•¡æˆ–èŒ¶æç¥'];
      timeContext.activities = ['é«˜æ•ˆå·¥ä½œ', 'å¤´è„‘é£æš´', 'é‡è¦ä¼šè®®'];
      timeContext.concerns = ['è®°å¾—ç»™çœ¼ç›ä¼‘æ¯', 'ä¿æŒæ°´åˆ†', 'åˆ«è¢«çäº‹åˆ†æ•£æ³¨æ„åŠ›'];
    }
  } else if (hour >= 12 && hour < 14) {
    timeContext.period = 'ä¸­åˆ';
    
    if (savageMode) {
      timeContext.suggestions = ['æš´é¥®æš´é£Ÿåè£…æ¸…é†’', 'æ‰¾å€Ÿå£åˆä¼‘å¤šç¡ä¸€ä¼š', 'åƒå®Œå°±çŠ¯å›°'];
      timeContext.activities = ['å·å·åŠ é¤', 'åŠå…¬æ¡Œå‰é—­çœ¼è£…æ€è€ƒ', 'åˆä¼‘æ—¶é—´åˆ·å‰§'];
      timeContext.concerns = ['è¢«åŒäº‹å‘ç°æ‰“çŒç¡', 'é¥­åçš„æ— é™å›°æ„', 'ä¸‹åˆè¿˜æœ‰ä¸€å †æ´»æ²¡åš'];
    } else {
      timeContext.suggestions = ['åƒé¡¿è¥å…»åˆé¤', 'çŸ­æš‚åˆä¼‘', 'æ”¾æ¾ç´§å¼ çš„æ€ç»´'];
      timeContext.activities = ['ä¸æœ‹å‹å…±è¿›åˆé¤', 'ä¼‘æ¯å’Œæ¢å¤', 'çŸ­è·ç¦»æ•£æ­¥'];
      timeContext.concerns = ['åˆ«é”™è¿‡åƒé¥­', 'é¿å…å·¥ä½œå ç”¨ä¼‘æ¯æ—¶é—´', 'ç»™è‡ªå·±å……ç”µçš„æœºä¼š'];
    }
  } else if (hour >= 14 && hour < 18) {
    timeContext.period = 'ä¸‹åˆ';
    
    if (savageMode) {
      timeContext.suggestions = ['å‡è£…æ¸…é†’', 'ç”¨å’–å•¡å› æ©ç›–ç–²æƒ«', 'æ‹–å»¶åˆ°ä¸‹ç­'];
      timeContext.activities = ['çœ‹ç€æ—¶é’Ÿç­‰ä¸‹ç­', 'ç¼–é€ æ˜å¤©è¦åšçš„ç†ç”±', 'å‡è£…åœ¨æ€è€ƒ'];
      timeContext.concerns = ['è¢«å‘ç°å·¥ä½œæ²¡å®Œæˆ', 'æ— é™æ¼«é•¿çš„ä¸‹åˆ', 'çŠ¯å›°è¢«æŠ“åŒ…'];
    } else {
      timeContext.suggestions = ['å…‹æœç–²æƒ«æ„Ÿ', 'é€‚å½“è¡¥å……èƒ½é‡', 'é‡æ–°èšç„¦ç›®æ ‡'];
      timeContext.activities = ['å¤„ç†ç§¯å‹å·¥ä½œ', 'åˆ›æ„æ€è€ƒ', 'è®¡åˆ’æ˜å¤©'];
      timeContext.concerns = ['é¿å…è¿‡åº¦å’–å•¡å› ', 'è°ƒæ•´åå§¿', 'æ³¨æ„ä¸‹åˆçš„ä½è°·æœŸ'];
    }
  } else if (hour >= 18 && hour < 21) {
    timeContext.period = 'å‚æ™š';
    
    if (savageMode) {
      timeContext.suggestions = ['è£…ä½œæœ‰ç¤¾äº¤ç”Ÿæ´»', 'ç‚¹å¤–å–è¿˜å‡è£…æ˜¯è‡ªå·±åšçš„', 'åœ¨ç¤¾åª’æ™’è™šå‡çš„ç²¾å½©ç”Ÿæ´»'];
      timeContext.activities = ['åˆ·å‰§', 'åˆ·æ‰‹æœº', 'å¯¹ç€å†°ç®±å‘å‘†'];
      timeContext.concerns = ['å‡è£…è‡ªå·±å¾ˆå¿™', 'ä¸æ•¢é¢å¯¹æ˜å¤©çš„å·¥ä½œ', 'å†…å¿ƒç©ºè™šä½†è¿˜è¦è£…å……å®'];
    } else {
      timeContext.suggestions = ['æ”¾ä¸‹å·¥ä½œ', 'äº«å—æ™šé¤', 'ä¸å®¶äººç›¸å¤„'];
      timeContext.activities = ['è¿åŠ¨', 'æ”¾æ¾èº«å¿ƒ', 'ä¸ªäººçˆ±å¥½'];
      timeContext.concerns = ['ä¸è¦æŠŠå·¥ä½œå¸¦å›å®¶', 'æ”¾æ…¢è„šæ­¥', 'äº«å—è¿™æ®µå®è´µæ—¶å…‰'];
    }
  } else if (hour >= 21 && hour < 24) {
    timeContext.period = 'æ™šä¸Š';
    
    if (savageMode) {
      timeContext.suggestions = ['å‡è£…è‡ªå·±ä¼šæ—©ç¡', 'ç†¬å¤œè¿˜è¯´æ˜å¤©æ—©èµ·', 'æ‹–å»¶ç¡è§‰æ—¶é—´'];
      timeContext.activities = ['æ²‰è¿·åˆ·æ‰‹æœº', 'è¾¹çœ‹å‰§è¾¹è¯´å°±ä¸€é›†', 'ç¡å‰ç„¦è™‘æ˜å¤©çš„å·¥ä½œ'];
      timeContext.concerns = ['åˆè¦é»‘çœ¼åœˆäº†', 'æ˜å¤©èµ·ä¸æ¥æ€ä¹ˆåŠ', 'æ˜æ˜å›°å´èˆä¸å¾—ç¡'];
    } else {
      timeContext.suggestions = ['ä¸ºæ˜å¤©åšå‡†å¤‡', 'æ”¾æ¾å¿ƒæƒ…', 'å›é¡¾ä»Šå¤©çš„æ”¶è·'];
      timeContext.activities = ['é˜…è¯»', 'æ´—ä¸ªèˆ’æœçš„çƒ­æ°´æ¾¡', 'è®°å½•æ—¥è®°'];
      timeContext.concerns = ['é¿å…å¤ªæ™šæ¥è§¦ç”µå­å±å¹•', 'ä¿æŒèˆ’é€‚ç¡çœ ç¯å¢ƒ', 'è®¾å®šæ˜ç¡®çš„ç¡çœ æ—¶é—´'];
    }
  } else {
    timeContext.period = 'æ·±å¤œ';
    
    if (savageMode) {
      timeContext.suggestions = ['è£…æ¸…é†’ç©æ‰‹æœº', 'æ˜å¤©çš„é»‘çœ¼åœˆåˆæœ‰ç†ç”±äº†', 'ç†¬å¤œååˆè¦ç¼–å€Ÿå£'];
      timeContext.activities = ['æ— æ„ä¹‰çš„åˆ·å‰§', 'ä¸ºç†¬å¤œæ‰¾å€Ÿå£', 'è‡ªæˆ‘æ¬ºéª—å¼çš„"æœ€åä¸€æŠŠ"'];
      timeContext.concerns = ['æ˜å¤©èµ·åºŠåˆè¦ç—›è‹¦', 'åˆè¦é å’–å•¡å› ç»­å‘½', 'ç”Ÿç‰©é’Ÿæ··ä¹±è¿˜ä¸è‡ªçŸ¥'];
    } else {
      timeContext.suggestions = ['å°½å¿«ä¼‘æ¯', 'å…³å¿ƒè‡ªå·±çš„ç¡çœ ', 'æ”¾ä¸‹æ‰‹æœº'];
      timeContext.activities = ['è¿›å…¥ç¡çœ ', 'å†¥æƒ³', 'æ·±å‘¼å¸æ”¾æ¾'];
      timeContext.concerns = ['ç†¬å¤œå¯¹èº«ä½“ä¸å¥½', 'ç¡çœ è´¨é‡å½±å“æ˜å¤©', 'ç…§é¡¾å¥½è‡ªå·±æ¯”ä»€ä¹ˆéƒ½é‡è¦'];
    }
  }
  
  return {
    formattedTime,
    timeContext
  };
}

/**
 * å¤‡ç”¨æ–¹æ¡ˆï¼šæœ¬åœ°ç”Ÿæˆå†…å®¹ï¼ˆAPIä¸å¯ç”¨æ—¶ï¼‰
 * @param {Object} params ç”Ÿæˆå‚æ•°
 * @returns {string} ç”Ÿæˆçš„å†…å®¹
 */
export function generateLocalContent(params) {
  const zodiacChinese = zodiacMap[params.zodiac] || 'æœªçŸ¥æ˜Ÿåº§';
  const mbtiType = params.mbti || 'MBTIç±»å‹';
  const { timeContext } = getTimeContext();
  
  // æ ¹æ®æ€§æ ¼ç±»å‹å’Œæ—¶é—´åˆ›å»ºå®šåˆ¶åŒ–çš„æ¨¡æ¿
  const templates = [];
  
  // å¦‚æœå¯ç”¨äº†æ¯’èˆŒæ¨¡å¼ï¼Œä½¿ç”¨æ¯’èˆŒæ¨¡æ¿
  if (params.savageMode) {
    // æ·»åŠ æ¯’èˆŒæ¨¡æ¿
    switch(params.zodiac) {
      case 'aries':
        templates.push(
          `åˆåœ¨å†²åŠ¨è¡Œäº‹äº†å§ï¼Ÿæƒ³æƒ³ä¸Šæ¬¡ä½ æ‹è„‘è¢‹åšå†³å®šçš„åæœã€‚è¿™ä¹ˆå¤šå¹´äº†è¿˜å­¦ä¸ä¼šæ€è€ƒå—ï¼Ÿ`,
          `å¬è¯´ä½ åˆæœ‰äº†æ–°è®¡åˆ’ï¼Œç„¶åä¸‰å¤©åå°±ä¼šåƒå¾€å¸¸ä¸€æ ·æ”¾å¼ƒï¼Œä¸æ„§æ˜¯ä¸‰åˆ†é’Ÿçƒ­åº¦ä¸“ä¸šæˆ·ã€‚`
        );
        break;
      case 'taurus':
        templates.push(
          `è¿™éƒ½èƒ½æƒ³è¿™ä¹ˆä¹…ï¼Ÿåˆ«äººéƒ½å®Œäº‹äº†ä½ è¿˜åœ¨åŸåœ°è¸æ­¥ï¼Œå›ºæ‰§å¾—åƒå¤´çœŸç‰›ã€‚`,
          `åˆåœ¨å›¤ç§¯æ— ç”¨çš„ä¸œè¥¿äº†å§ï¼Ÿä½ é‚£å±‹å­è¿Ÿæ—©å˜æˆåºŸå“æ”¶è´­ç«™ï¼Œç‰©è´¨ä¸»ä¹‰æ•‘ä¸äº†ä½ çš„ç©ºè™šã€‚`
        );
        break;
      case 'gemini':
        templates.push(
          `ä½ ä»Šå¤©æƒ³æ³•åˆå˜äº†å‡ æ¬¡ï¼Ÿæˆ‘å»ºè®®ä½ è¿½è¸ªä¸€ä¸‹ï¼Œå¯èƒ½ä¼šç ´ä¸–ç•Œçºªå½•ã€‚`,
          `åˆšè¯´çš„è¯å°±å¿˜äº†ï¼ŸçœŸå¥½å¥‡ä½ å¤§è„‘é‡Œé‚£äº›æƒ³æ³•éƒ½é£å“ªå»äº†ï¼Œæ³¨æ„åŠ›æ¯”é‡‘é±¼è¿˜çŸ­ã€‚`
        );
        break;
      case 'cancer':
        templates.push(
          `åˆåœ¨é’»ç‰›è§’å°–äº†ï¼Ÿæ¯”èµ·æ´»åœ¨è‡ªå·±çš„æƒ…ç»ªæ¼©æ¶¡é‡Œï¼Œä¸å¦‚çœ‹çœ‹ç°å®ä¸–ç•Œã€‚`,
          `ä½ è®°ä»‡çš„æœ¬äº‹éƒ½å¤Ÿå†™ä¸€æœ¬ä¹¦äº†ï¼Œè¦ä¸è¦å‡ºç‰ˆä¸€ä¸‹ã€Šå¦‚ä½•æŠŠå°äº‹è®°ä¸€è¾ˆå­ã€‹ï¼Ÿ`
        );
        break;
      case 'leo':
        templates.push(
          `ä¸æ˜¯æ‰€æœ‰äººéƒ½åœ¨å…³æ³¨ä½ ï¼Œå¶å°”æ”¾ä¸‹ä½ çš„è‡ªæˆ‘è¡¨æ¼”æ¬²æœ›ï¼Œè¯•è¯•åšä¸ªæ™®é€šäººã€‚`,
          `åˆéœ€è¦åˆ«äººå¤¸ä½ äº†ï¼Ÿä½ çš„è‡ªä¿¡æ¯”çº¸è¿˜è–„ï¼Œæ²¡äººé¼“æŒå°±æ´»ä¸ä¸‹å»æ˜¯å§ï¼Ÿ`
        );
        break;
      case 'virgo':
        templates.push(
          `ä½ é‚£ä»½å®Œç¾ä¸»ä¹‰æŠ¥è¡¨åšå¥½äº†å—ï¼Ÿä¸å®Œç¾å°±æ´»ä¸äº†çš„å¼ºè¿«ç—‡åˆçŠ¯äº†ï¼Ÿ`,
          `ä¸–ç•Œä¸Š99%çš„äº‹ç‰©éƒ½è¾¾ä¸åˆ°ä½ çš„æ ‡å‡†ï¼ŒåŒ…æ‹¬ä½ è‡ªå·±ï¼Œä½•å¿…è¿™ä¹ˆè‹›åˆ»å‘¢ï¼Ÿ`
        );
        break;
      case 'libra':
        templates.push(
          `ä»Šå¤©çº ç»“äº†å¤šä¹…æ‰å†³å®šç©¿è¿™èº«è¡£æœï¼Ÿé€‰æ‹©å›°éš¾ç—‡æ™šæœŸäº†å§ã€‚`,
          `è¡¨é¢å’Œè°å¤§å¸ˆï¼Œå¿ƒé‡Œæ˜æ˜æœ‰ä¸€å †çœ‹æ³•ï¼Œå´æ°¸è¿œåªä¼šè¯´"éƒ½è¡Œ"ï¼ŒçœŸæœ‰ä½ çš„ã€‚`
        );
        break;
      case 'scorpio':
        templates.push(
          `åˆåœ¨æ·±æ€ç†Ÿè™‘å„ç§é˜´è°‹è®ºäº†ï¼Ÿæé†’ä½ ä¸€ä¸‹ï¼Œç°å®æ²¡ä½ æƒ³çš„é‚£ä¹ˆå¤æ‚ã€‚`,
          `ä½ é‚£suspiciousçš„çœ¼ç¥èƒ½æŠŠæœ‹å‹éƒ½çœ‹æ²¡äº†ï¼Œä¸æ˜¯æ¯ä¸ªäººéƒ½æœ‰ç§˜å¯†åŠ¨æœºã€‚`
        );
        break;
      case 'sagittarius':
        templates.push(
          `è®¡åˆ’ä¸‹ä¸€æ¬¡æ—…è¡Œäº†ï¼Ÿè®°å¾—è¿™æ¬¡åˆ«åŠé€”è€ŒåºŸï¼Œå®Œæˆä¸€æ¬¡å†å¼€å§‹å¹å˜˜ã€‚`,
          `å˜´ä¸Šè¯´ç€å¤§é“ç†ï¼Œè¡ŒåŠ¨ä¸Šå´æ€»æ˜¯è™å¤´è›‡å°¾ï¼Œè‡ªç”±çš„çµé­‚ä¹Ÿè¦å¯¹è‡ªå·±è´Ÿè´£å•Šã€‚`
        );
        break;
      case 'capricorn':
        templates.push(
          `ä½ æœ‰å¤šä¹…æ²¡å¨±ä¹äº†ï¼Ÿå·¥ä½œç‹‚ä¸Šç˜¾äº†ï¼Ÿç”Ÿæ´»ä¸åªæœ‰å·¥ä½œå’Œæˆå°±ï¼ŒæŠ¬å¤´çœ‹çœ‹å¤©ç©ºã€‚`,
          `ä½ çš„äººç”Ÿè§„åˆ’è¡¨åšåˆ°80å²äº†å§ï¼Ÿå¯æƒœè®¡åˆ’èµ¶ä¸ä¸Šå˜åŒ–ï¼Œå¶å°”ä¹Ÿè¦å­¦ä¼šéšæ€§ä¸€ç‚¹ã€‚`
        );
        break;
      case 'aquarius':
        templates.push(
          `åˆæ²‰æµ¸åœ¨è‡ªå·±çš„å¥‡æ€å¦™æƒ³é‡Œäº†ï¼Ÿè®°å¾—å¶å°”å›åˆ°åœ°çƒï¼Œæˆ‘ä»¬æ™®é€šäººçœ‹ä¸æ‡‚ä½ çš„é¢‘é“ã€‚`,
          `ä½ è§‰å¾—è‡ªå·±å¾ˆç‰¹ç«‹ç‹¬è¡Œå§ï¼Ÿå…¶å®ä¸è¿‡æ˜¯å¦ä¸€ç§éšå¤§æµï¼Œå«åš"åˆ»æ„ä¸ä¼—ä¸åŒ"ã€‚`
        );
        break;
      case 'pisces':
        templates.push(
          `ä»Šå¤©åˆåœ¨åšç™½æ—¥æ¢¦äº†å§ï¼Ÿæé†’ä½ ä¸€ä¸‹ï¼Œè´¦å•ä¸ä¼šè‡ªå·±ä»˜æ¸…ï¼Œæ¢¦æƒ³ä¹Ÿä¸ä¼šè‡ªåŠ¨å®ç°ã€‚`,
          `ç°å®å¤ªæ®‹é…·å°±é€ƒè¿›å¹»æƒ³ä¸–ç•Œï¼Ÿæœ‰æœ¬äº‹ç›´é¢é—®é¢˜ï¼Œè€Œä¸æ˜¯é æƒ³è±¡åŠ›è‡ªæˆ‘å®‰æ…°ã€‚`
        );
        break;
      default:
        templates.push(
          `ä¸çŸ¥é“ä½ åˆåœ¨çº ç»“ä»€ä¹ˆï¼Œåæ­£è‚¯å®šåˆæ˜¯äº›ä¸å¿…è¦çš„çƒ¦æ¼ã€‚`,
          `ä»¥ä½ ä¸€è´¯çš„ä½œé£ï¼Œç°åœ¨è‚¯å®šåˆåœ¨çŠ¯è€æ¯›ç—…å§ï¼Ÿ`
        );
    }
    
    // æ ¹æ®MBTIæ·»åŠ æ›´å¤šå®šåˆ¶åŒ–çš„æ¯’èˆŒæ¨¡æ¿
    if (mbtiType.includes('I')) {
      templates.push(`åˆèº²åœ¨è§’è½é‡Œè‡ªæˆ‘æ„ŸåŠ¨å‘¢ï¼Ÿç¤¾äº¤ææƒ§ç—‡æ™šæœŸäº†å§ï¼Œä¸–ç•Œä¸ä¼šå› ä¸ºä½ çš„ç¼ºå¸­è€Œåœè½¬ã€‚`);
    } else if (mbtiType.includes('E')) {
      templates.push(`èƒ½å®‰é™äº”åˆ†é’Ÿå—ï¼Ÿä¸è¯´è¯ä¼šæ­»æ˜¯å§ï¼Ÿæœ‰æ—¶å€™æ²‰é»˜æ¯”ä½ çš„å…«å¦å‘è¨€æ›´æœ‰ä»·å€¼ã€‚`);
    }
    
    if (mbtiType.includes('N')) {
      templates.push(`åˆåœ¨æƒ³é‚£äº›ä¸åˆ‡å®é™…çš„ç‚¹å­ï¼Ÿä½ çš„è„‘æ´èƒ½ç”¨æ¥å‘ç”µäº†ï¼Œå¯æƒœç°å®ä¸ä¹°è´¦ã€‚`);
    } else if (mbtiType.includes('S')) {
      templates.push(`ä½ çš„æ€ç»´è¿˜çœŸæ˜¯å®é™…å¾—æ— è¶£ï¼Œæƒ³è±¡åŠ›æ˜¯å°å­¦æ—¶å°±è¢«æ”¶èµ°äº†å—ï¼Ÿ`);
    }
    
    if (mbtiType.includes('T')) {
      templates.push(`æƒ…å•†æ˜¯è¢«ä½ åƒäº†å—ï¼Ÿä¸æ˜¯æ‰€æœ‰äº‹éƒ½éœ€è¦ä½ é‚£å¥—å†·å†°å†°çš„é€»è¾‘åˆ†æã€‚`);
    } else if (mbtiType.includes('F')) {
      templates.push(`åˆå› ä¸ºä¸€ç‚¹å°äº‹æƒ…ç»ªæ³¢åŠ¨äº†ï¼Ÿè§è°éƒ½å…±æƒ…ï¼Œè‡ªå·±çš„é—®é¢˜å´è§£å†³ä¸äº†ï¼ŒçœŸæœ‰ä½ çš„ã€‚`);
    }
    
    if (mbtiType.includes('J')) {
      templates.push(`ä½ çš„æ—¥ç¨‹è¡¨æ’å¾—æ¯”å›½å®¶äº”å¹´è®¡åˆ’è¿˜è¯¦ç»†ï¼Œæ§åˆ¶æ¬²è¿™ä¹ˆå¼ºä¸ç´¯å—ï¼Ÿ`);
    } else if (mbtiType.includes('P')) {
      templates.push(`ä»Šå¤©çš„æ‹–å»¶æ¸…å•å®Œæˆå¾—æ€ä¹ˆæ ·äº†ï¼Ÿæ˜¯ä¸æ˜¯åˆæ‰“ç®—"æ˜å¤©å†è¯´"ï¼Ÿ`);
    }
    
  } else {
    // ä½¿ç”¨åŸæœ‰çš„å‹å¥½æ¨¡æ¿
    switch(params.zodiac) {
      case 'aries':
        templates.push(
          `æœ‰æ—¶å€™ç›´æ¥ä¸Šæ‰‹æ¯”æ€è€ƒå¤ªå¤šæ›´æœ‰æ•ˆï¼Œä½ çŸ¥é“çš„ï¼Œå…ˆè¡ŒåŠ¨èµ·æ¥å§ã€‚${timeContext.period}æ˜¯ä¸ªä¸é”™çš„æ—¶æœºã€‚`,
          `åˆšæƒ³åˆ°ä¸€ä¸ªæ–°ç‚¹å­ï¼Œæ„Ÿè§‰ä½ ä¼šå–œæ¬¢ã€‚æœ‰ç©ºèŠèŠï¼Ÿå¯¹äº†ï¼Œ${timeContext.concerns[0] || 'æ³¨æ„åˆ«å¤ªå†²åŠ¨'}`
        );
        break;
      case 'taurus':
        templates.push(
          `æ…¢æ…¢æ¥ï¼Œç¨³æ‰ç¨³æ‰“æ‰æ˜¯ä½ çš„é£æ ¼ã€‚${timeContext.period}è®°å¾—${timeContext.suggestions[0] || 'ç»™è‡ªå·±ä¸€äº›èˆ’é€‚æ—¶å…‰'}ã€‚`,
          `è¿™ç§å˜åŒ–éœ€è¦æ—¶é—´é€‚åº”ï¼Œæ²¡å¿…è¦ç€æ€¥ã€‚å¯¹äº†ï¼Œ${timeContext.concerns[0] || 'è®°å¾—äº«å—å½“ä¸‹çš„ç¨³å®š'}`
        );
        break;
      case 'gemini':
        templates.push(
          `ä»Šå¤©æœ‰ä»€ä¹ˆæ–°é²œäº‹ï¼Ÿæ„Ÿè§‰ä½ åˆæœ‰ä¸€å †ç‚¹å­è¦åˆ†äº«ã€‚${timeContext.period}çš„æ—¶å€™æƒ³åˆ°ä½ äº†ã€‚`,
          `åˆ‡æ¢ä¸‹æ€è·¯ï¼Œåˆ«åœ¨åŒä¸€ä»¶äº‹ä¸Šå¤ªä¹…ï¼Œä½ éœ€è¦æ–°çš„åˆºæ¿€ã€‚${timeContext.suggestions[0] || 'å°è¯•ç‚¹æ–°ä¸œè¥¿'}`
        );
        break;
      case 'cancer':
        templates.push(
          `æœ€è¿‘æ„Ÿè§‰å¦‚ä½•ï¼Ÿè®°å¾—ç…§é¡¾å¥½è‡ªå·±çš„æƒ…ç»ªï¼Œ${timeContext.period}æ˜¯æ”¾æ¾çš„å¥½æ—¶æœºã€‚`,
          `æœ‰æ—¶å€™éœ€è¦ç»™è‡ªå·±ä¸€ç‚¹ä¿æŠ¤ï¼Œä¸å¿…å¯¹æ‰€æœ‰äººæ•å¼€å¿ƒæ‰‰ã€‚${timeContext.concerns[0] || 'ç…§é¡¾å¥½è‡ªå·±'}`
        );
        break;
      case 'leo':
        templates.push(
          `å˜¿ï¼Œæœ€è¿‘é‚£ä¸ªé¡¹ç›®è¿›å±•ä¸é”™å•Šï¼ŒçœŸä¸ºä½ éª„å‚²ã€‚${timeContext.period}ç»§ç»­ä¿æŒå…‰èŠ’ï¼`,
          `ä½ çš„ä¸»æ„æ€»æ˜¯é‚£ä¹ˆæœ‰åˆ›æ„ï¼Œåˆ†äº«å‡ºæ¥è®©å¤§å®¶çœ‹çœ‹å§ã€‚${timeContext.suggestions[0] || 'å±•ç¤ºä½ çš„æ‰å'}`
        );
        break;
      case 'virgo':
        templates.push(
          `ç»†èŠ‚å†³å®šæˆè´¥ï¼Œä½†å¶å°”ä¹Ÿåˆ«å¿˜äº†çœ‹çœ‹å…¨å±€ã€‚${timeContext.period}${timeContext.concerns[0] || 'åˆ«å¤ªè‹›è´£è‡ªå·±'}ã€‚`,
          `ä½ çš„åˆ†ææ€»æ˜¯è¿™ä¹ˆåˆ°ä½ï¼Œä¸è¿‡ä»Šå¤©å¯ä»¥ç¨å¾®æ”¾æ¾ä¸€ä¸‹æ ‡å‡†ã€‚${timeContext.suggestions[0] || 'åšç‚¹å¼€å¿ƒçš„äº‹'}`
        );
        break;
      case 'libra':
        templates.push(
          `æƒè¡¡åˆ©å¼Šæ˜¯å¥½äº‹ï¼Œä½†æœ‰æ—¶å€™ä¹Ÿéœ€è¦æœæ–­ä¸€ç‚¹ã€‚${timeContext.period}é€‚åˆåšä¸ªå†³å®šã€‚`,
          `ä½ æ€»èƒ½çœ‹åˆ°äº‹æƒ…çš„å„ä¸ªæ–¹é¢ï¼Œè¿™æ˜¯ç§å¤©èµ‹ã€‚${timeContext.suggestions[0] || 'æ‰¾æ‰¾å¹³è¡¡ç‚¹'}`
        );
        break;
      case 'scorpio':
        templates.push(
          `æœ‰äº›æƒ³æ³•ä¸å¿…è—å¤ªæ·±ï¼Œä¿¡ä»»çš„äººä¼šç†è§£ä½ ã€‚${timeContext.period}å¯ä»¥æ•å¼€å¿ƒæ‰‰ã€‚`,
          `ä½ çš„æ´å¯ŸåŠ›æ€»æ˜¯é‚£ä¹ˆæƒŠäººï¼Œåˆå‘ç°ä»€ä¹ˆæœ‰è¶£çš„äº‹äº†å—ï¼Ÿ${timeContext.concerns[0] || 'åˆ«æƒ³å¤ªå¤æ‚'}`
        );
        break;
      case 'sagittarius':
        templates.push(
          `åˆæœ‰ä»€ä¹ˆæ–°çš„å†’é™©è®¡åˆ’ï¼Ÿ${timeContext.period}æ­£é€‚åˆå±•å¼€æ–°æ—…ç¨‹ã€‚`,
          `è‡ªç”±çš„çµé­‚éœ€è¦ç©ºé—´ï¼Œä¸è¦è¢«çäº‹å›°ä½ã€‚${timeContext.suggestions[0] || 'æ”¾é£è‡ªæˆ‘'}`
        );
        break;
      case 'capricorn':
        templates.push(
          `è„šè¸å®åœ°çš„åŠªåŠ›ç»ˆä¼šæœ‰å›æŠ¥ï¼Œä½†åˆ«å¿˜äº†å¶å°”æŠ¬å¤´çœ‹çœ‹é£æ™¯ã€‚${timeContext.period}${timeContext.suggestions[0] || 'æ­‡ä¸€æ­‡'}ã€‚`,
          `ä½ çš„è§„åˆ’èƒ½åŠ›æ€»æ˜¯è®©äººä½©æœï¼Œä¸è¿‡ä»Šå¤©å¯ä»¥ç¨å¾®æ”¾æ¾äº›ã€‚${timeContext.concerns[0] || 'åˆ«å¤ªä¸¥è‚ƒ'}`
        );
        break;
      case 'aquarius':
        templates.push(
          `ä½ çš„æƒ³æ³•æ€»æ˜¯ä¸ä¼—ä¸åŒï¼Œç»§ç»­ä¿æŒè¿™ç§ç‹¬ç«‹æ€è€ƒã€‚${timeContext.period}é€‚åˆåˆ›æ–°ã€‚`,
          `æœ‰æ—¶å€™èµ°å¯»å¸¸è·¯ä¹Ÿæ²¡å…³ç³»ï¼Œä¸å¿…æ€»æ˜¯æ‰“ç ´å¸¸è§„ã€‚${timeContext.suggestions[0] || 'å°è¯•æ™®é€šäººçš„ç”Ÿæ´»'}`
        );
        break;
      case 'pisces':
        templates.push(
          `ä½ çš„æ„Ÿå—æ€»æ˜¯é‚£ä¹ˆç»†è…»ï¼Œè®°å¾—æœ‰æ—¶ä¹Ÿéœ€è¦å›åˆ°ç°å®ã€‚${timeContext.period}${timeContext.concerns[0] || 'åˆ«è¿·å¤±åœ¨æƒ³è±¡ä¸­'}ã€‚`,
          `ä½ çš„åŒç†å¿ƒæ˜¯çè´µçš„ç¤¼ç‰©ï¼Œä½†ä¹Ÿè¦ç…§é¡¾å¥½è‡ªå·±ã€‚${timeContext.suggestions[0] || 'ç•™ç‚¹æ—¶é—´ç»™è‡ªå·±'}`
        );
        break;
      default:
        templates.push(
          `${timeContext.period}äº†ï¼Œ${timeContext.suggestions[0] || 'ç…§é¡¾å¥½è‡ªå·±'}ã€‚æƒ³èŠèŠä»Šå¤©çš„æ„Ÿå—å—ï¼Ÿ`,
          `æ¯ä¸ªäººéƒ½æœ‰ç‹¬ç‰¹ä¹‹å¤„ï¼Œä½ çš„æ–¹å¼å¾ˆç‰¹åˆ«ã€‚${timeContext.concerns[0] || 'ç»§ç»­åšè‡ªå·±'}`
        );
    }
    
    // æ ¹æ®MBTIæ·»åŠ æ›´å¤šå®šåˆ¶åŒ–æ¨¡æ¿
    if (mbtiType.includes('I')) {
      templates.push(`éœ€è¦ç‹¬å¤„å……ç”µçš„æ—¶å€™åˆ«ä¸å¥½æ„æ€ï¼Œè¿™æ˜¯ä½ æ¢å¤èƒ½é‡çš„æ–¹å¼ã€‚${timeContext.period}é€‚åˆå®‰é™çš„æ´»åŠ¨ã€‚`);
    } else if (mbtiType.includes('E')) {
      templates.push(`${timeContext.period}äº†ï¼Œæ‰¾äº›æœ‹å‹èŠèŠå¤©ï¼Ÿç¤¾äº¤èƒ½è®©ä½ æ´»åŠ›æ»¡æ»¡ã€‚`);
    }
    
    if (mbtiType.includes('N')) {
      templates.push(`ä½ çš„æƒ³è±¡åŠ›æ€»æ˜¯è®©äººæƒŠå¹ï¼Œæ€è€ƒçš„å¹¿åº¦å’Œæ·±åº¦éƒ½å¾ˆç‰¹åˆ«ã€‚ä»Šå¤©æœ‰ä»€ä¹ˆæ–°å‘ç°ï¼Ÿ`);
    } else if (mbtiType.includes('S')) {
      templates.push(`è„šè¸å®åœ°çš„æ€åº¦å¾ˆéš¾å¾—ï¼Œä½ æ€»èƒ½æŠŠäº‹æƒ…åšå¾—å®å®åœ¨åœ¨ã€‚${timeContext.concerns[0] || 'åˆ«å¿˜äº†ç»†èŠ‚'}`);
    }
    
    // æ·»åŠ å¿ƒæƒ…ç›¸å…³æ¨¡æ¿
    if (params.mood) {
      templates.push(`${params.mood}çš„æ—¶å€™ï¼Œæœ€éœ€è¦çš„æ˜¯ä»€ä¹ˆï¼Ÿå¯¹ä½ æ¥è¯´å¯èƒ½æ˜¯${mbtiType.includes('I') ? 'ç‰‡åˆ»å®‰é™' : 'æœ‹å‹é™ªä¼´'}ã€‚`);
    }
    
    // æ·»åŠ é€šç”¨æ¨¡æ¿ä½œä¸ºåå¤‡
    templates.push(
      `${timeContext.period}å¥½ï¼Œæƒ³åˆ°ä½ å¯èƒ½æ­£åœ¨${timeContext.activities[0] || 'å¿™ç¢Œ'}ï¼Œè®°å¾—ç…§é¡¾å¥½è‡ªå·±ã€‚`,
      `æœ‰æ—¶å€™ï¼Œ${timeContext.suggestions[1] || 'æ”¾æ…¢è„šæ­¥'}å¯¹ä½ æ¥è¯´ç‰¹åˆ«é‡è¦ï¼Œå°¤å…¶æ˜¯${timeContext.period}æ—¶åˆ†ã€‚`
    );
  }
  
  // åŒè¯­æ”¯æŒ
  if (params.language === 'en-zh') {
    // ä¸ºåŒè¯­å‡†å¤‡çš„æ¨¡æ¿
    const bilingualTemplates = [];
    
    if (params.savageMode) {
      // æ·»åŠ æ¯’èˆŒçš„åŒè¯­æ¨¡æ¿
      bilingualTemplates.push(
        `ä½ é‚£"ç‹¬ç‰¹"çš„å¤„äº‹æ–¹å¼è¿˜çœŸæ˜¯è®©äººå¹ä¸ºè§‚æ­¢ï¼Œèƒ½æŠŠç®€å•çš„äº‹æå¾—å¦‚æ­¤å¤æ‚ä¹Ÿæ˜¯ç§æ‰èƒ½ã€‚\nYour "unique" way of handling things is truly breathtaking. Making simple things complicated must be your special talent.`,
        `ä½ ä»¥ä¸ºæ²¡äººçœ‹å‡ºä½ çš„å°å¿ƒæ€å—ï¼Ÿé‚£ç‚¹å°æŠŠæˆè¿å°å­¦ç”Ÿéƒ½éª—ä¸äº†ã€‚\nYou think no one sees through your little tricks? Those games wouldn't fool even a child.`
      );
    } else {
      bilingualTemplates.push(
        `${timeContext.period}äº†ï¼Œæƒ³èµ·ä½ æ¥ï¼Œè®°å¾—ç…§é¡¾å¥½è‡ªå·±ã€‚\nIt's ${timeContext.period} now, thought of you, remember to take care of yourself.`,
        `ä»¥ä½ çš„æ–¹å¼å‰è¿›ï¼Œä¸å¿…åŒ†å¿™ã€‚æ…¢æ…¢æ¥ï¼Œäº«å—è¿‡ç¨‹ã€‚\nMove forward in your own way, no need to rush. Take it slow and enjoy the process.`
      );
    }
    
    if (bilingualTemplates.length > 0) {
      return bilingualTemplates[Math.floor(Math.random() * bilingualTemplates.length)];
    }
  }
  
  // éšæœºé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿
  return templates[Math.floor(Math.random() * templates.length)];
}
